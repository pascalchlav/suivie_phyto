<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Traitements Phytosanitaires - Vignoble</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Source Sans 3', sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
        }
        
        .header-title {
            font-family: 'Playfair Display', serif;
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .ilot-header {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
            transition: all 0.3s ease;
        }
        
        .ilot-header:hover {
            transform: translateX(4px);
        }
        
        .traitement-card {
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }
        
        .traitement-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateX(4px);
        }
        
        .ift-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        
        .toast.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }
        
        .toast.success {
            background: white;
            border-left: 4px solid #10b981;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Optimisations Mobile */
        @media (max-width: 640px) {
            /* Textes plus lisibles */
            body {
                font-size: 14px;
            }
            
            /* Padding r√©duit sur mobile */
            .card-glass {
                padding: 1rem !important;
            }
            
            /* Boutons plus grands pour le tactile */
            button, select, input[type="text"], input[type="date"], input[type="number"], textarea {
                min-height: 44px;
                font-size: 16px; /* √âvite le zoom automatique iOS */
            }
            
            /* Modals plein √©cran sur mobile */
            .fixed.inset-0 > div {
                max-height: 95vh !important;
                margin: 0.5rem !important;
            }
            
            /* Espacements r√©duits */
            .mb-6 {
                margin-bottom: 1rem !important;
            }
            
            .gap-4 {
                gap: 0.75rem !important;
            }
            
            /* Titre plus petit */
            .header-title {
                font-size: 2rem !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

// Ic√¥nes SVG
const Download = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
    </svg>
);

const Upload = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
    </svg>
);

const Plus = ({ size = 18 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
);

const Trash2 = ({ size = 18 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        <line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
    </svg>
);

const Copy = ({ size = 16 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
    </svg>
);

const ChevronDown = ({ size = 24 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 12 15 18 9"/>
    </svg>
);

const ChevronUp = ({ size = 24 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="18 15 12 9 6 15"/>
    </svg>
);

const Save = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
        <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
    </svg>
);

const Search = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
);

const Calendar = ({ size = 16 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
);

const AlertTriangle = ({ size = 16 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg>
);

const CheckCircle = ({ size = 16 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
    </svg>
);

const RefreshCw = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
    </svg>
);

const Edit = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
    </svg>
);

const Settings = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.66-15.66l-4.24 4.24m-2.83 2.83L6.34 22.66M23 12h-6m-6 0H1m15.66 5.66l-4.24-4.24m-2.83-2.83L1.34 6.34"/>
    </svg>
);

const Cloud = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
    </svg>
);

const CloudOff = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"/>
        <line x1="1" y1="1" x2="23" y2="23"/>
    </svg>
);

const PhytoTracker = () => {
    const [annee, setAnnee] = useState(new Date().getFullYear());
    const [searchTerm, setSearchTerm] = useState('');
    const [toast, setToast] = useState(null);
    
    const ilots = [
        { nom: 'Bommes', parcelles: [
            'Droite', 'Gauche', 'BARTHE (√† cot√© gauche)', 'Augey (entre 2x8)', '2x8', 'Sauvignon route', 
            'Aromatique', 'Jardin', 'Pointe', 'Dumas grande', 'Plante 97', 'Pons',
            'Mahon', 'Goulard vieille', 'Goulard plante', 'Bosquet vieille', 
            'Bosquet plante', 'Trinquine route', 'Trinquine cerisier'
        ]},
        { nom: 'Preignac', parcelles: [
            'Sensin', 'Mallet', 'Sauvignon mallet', 'Sauvignon hubert', 'Maison neuve 2 Ha',
            'DEVANT SERGE', 'CONTRE SERGE', 'CUVIER'
        ]},
        { nom: 'Devant Chateaux', parcelles: [
            'Centrale route', 'Centrale wc', 'WC Serge', 'Le mont', 'Pavillon'
        ]},
        { nom: 'Derri√®re Chateaux', parcelles: [
            'Semillon/ Sauvignon/ Pointe', 'Plateau', 'Ex-Bordeaux', 'Ruine', 'Chemin', 'Ricaud'
        ]},
        { nom: 'Toulenne', parcelles: [
            'Merlot', 'Cabernet'
        ]},
        { nom: 'Illats', parcelles: [
            'Blanc', 'Pr√©', '6 rgs', '22 rgs', 'Cabernet franc (14)', 'CF 8'
        ]},
        { nom: 'Artigue', parcelles: [
            'Merlot'
        ]},
        { nom: 'Portets', parcelles: [
            'Merlot', 'Petit Verdot', 'Centre'
        ]}
    ];

    // Base de donn√©es des produits avec leurs doses de r√©f√©rence pour le calcul de l'IFT
    const produitsParDefaut = [
        { nom: 'Mikal', doseRef: 4, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Microthiol', doseRef: 12.5, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Kumulus', doseRef: 12.5, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Soufre', doseRef: 12.5, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Pandero gold', doseRef: 2, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Conydia', doseRef: 0.5, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Mayandra black rot', doseRef: 0.4, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Sufrea quick', doseRef: 12.5, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Disco', doseRef: 0.2, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Natchez', doseRef: 0.125, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Pack Bria zorvec', doseRef: 1, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Ampexio', doseRef: 0.5, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Kusti', doseRef: 0.2, unite: 'L/ha', categorie: 'Insecticide' },
        { nom: 'Dynali', doseRef: 0.5, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Cythrine', doseRef: 0.3, unite: 'L/ha', categorie: 'Insecticide' },
        { nom: 'Futura', doseRef: 4, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Vivando', doseRef: 0.2, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Deltastar', doseRef: 0.5, unite: 'L/ha', categorie: 'Insecticide' },
        { nom: 'Mavrik', doseRef: 0.3, unite: 'L/ha', categorie: 'Insecticide' },
        { nom: 'Majox', doseRef: 2, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Lbg', doseRef: 4, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Affirm', doseRef: 1.5, unite: 'kg/ha', categorie: 'Insecticide' },
        { nom: '√âlectis bleu', doseRef: 2.8, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Nordox', doseRef: 2, unite: 'kg/ha', categorie: 'Fongicide' },
        { nom: 'Trebon citadelle', doseRef: 0.3, unite: 'L/ha', categorie: 'Insecticide' },
        { nom: 'Mayanda oidium', doseRef: 0.5, unite: 'L/ha', categorie: 'Fongicide' },
        { nom: 'Trebon tordeuse', doseRef: 0.4, unite: 'L/ha', categorie: 'Insecticide' },
        { nom: 'Kerb', doseRef: 1.875, unite: 'L/ha', categorie: 'Herbicide' },
        { nom: 'Buggy', doseRef: 6, unite: 'L/ha', categorie: 'Herbicide' },
        { nom: 'Pledge', doseRef: 1.2, unite: 'kg/ha', categorie: 'Herbicide' },
        { nom: 'Katana', doseRef: 0.2, unite: 'L/ha', categorie: 'Herbicide' },
        { nom: 'FOXY', doseRef: 1.7, unite: 'L/hl', categorie: 'Adjuvant' },
        { nom: 'DJEEN', doseRef: 1.5, unite: 'L/hl', categorie: 'Adjuvant' }
    ];

    const [produitsDisponibles, setProduitsDisponibles] = useState(produitsParDefaut);

    const initParcelles = () => {
        let parcelles = [];
        let id = 1;
        ilots.forEach(ilot => {
            if (ilot.parcelles) {
                // Parcelles avec noms personnalis√©s
                ilot.parcelles.forEach(nomParcelle => {
                    parcelles.push({
                        id: id++,
                        ilot: ilot.nom,
                        nom: nomParcelle,
                        surface: '',
                        traitements: []
                    });
                });
            } else {
                // Parcelles avec num√©rotation automatique
                for (let i = 1; i <= ilot.nbParcelles; i++) {
                    parcelles.push({
                        id: id++,
                        ilot: ilot.nom,
                        nom: `${ilot.nom} ${i}`,
                        surface: '',
                        traitements: []
                    });
                }
            }
        });
        return parcelles;
    };

    // Chargement des donn√©es depuis localStorage
    const loadData = () => {
        // On ne charge plus depuis localStorage, on part toujours vide
        // Les donn√©es seront charg√©es uniquement depuis Google Drive
        return {
            parcelles: initParcelles(),
            operateurs: ['', ''],
            machines: []
        };
    };

    const [parcelles, setParcelles] = useState(loadData().parcelles);
    const [operateurs, setOperateurs] = useState(loadData().operateurs);
    const [machines, setMachines] = useState(loadData().machines);

    const [showCopyModal, setShowCopyModal] = useState(false);
    const [traitementACopier, setTraitementACopier] = useState(null);
    const [parcellesSelectionnees, setParcellesSelectionnees] = useState([]);
    const [ilotsOuverts, setIlotsOuverts] = useState(ilots.map(i => i.nom));
    const [showGestionParcelles, setShowGestionParcelles] = useState(false);
    const [showGestionProduits, setShowGestionProduits] = useState(false);
    const [googleDriveConnected, setGoogleDriveConnected] = useState(false);
    const [googleAccessToken, setGoogleAccessToken] = useState(null);
    const [autoSyncEnabled, setAutoSyncEnabled] = useState(false);
    const [sharedFolderId, setSharedFolderId] = useState(null);
    const [modeReadOnly, setModeReadOnly] = useState(false);
    const [derniereCopie, setDerniereCopie] = useState(null);
    
    // √âtats pour l'autocompl√©tion des produits
    const [searchProduit, setSearchProduit] = useState({});
    const [showSuggestions, setShowSuggestions] = useState({});
    
    // M√©moire des num√©ros de lots par produit
    const [lotsParProduit, setLotsParProduit] = useState({});
    
    // Flag pour emp√™cher la sauvegarde automatique pendant/apr√®s le chargement
    const [isLoadingFromDrive, setIsLoadingFromDrive] = useState(false);
    
    // Flag pour emp√™cher les sauvegardes simultan√©es (race conditions)
    const [isSaving, setIsSaving] = useState(false);
    
    // Compteur d'√©checs de sauvegarde pour alerter l'utilisateur
    const [saveFailureCount, setSaveFailureCount] = useState(0);
    
    // √âtats pour les traitements globaux
    const [showTraitementGlobal, setShowTraitementGlobal] = useState(false);
    const [showDesherbageGlobal, setShowDesherbageGlobal] = useState(false);
    const [traitementGlobal, setTraitementGlobal] = useState({
        date: '',
        produits: [{ produit: '', numeroLot: '', doseHa: '' }],
        operateur1: '',
        machine: '',
        debit: '',
        commentaire: ''
    });
    const [parcellesSelectionneesglobal, setParcellesSelectionneesGlobal] = useState([]);

    // Toast notification
    const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
    };

    // V√©rifier si modifications autoris√©es
    const verifierModificationAutorisee = () => {
        if (modeReadOnly) {
            showToast('Modifications bloqu√©es - Reconnectez-vous √† Google Drive', 'error');
            return false;
        }
        return true;
    };

    // Changement d'ann√©e
    // Importer un fichier JSON local
    const importerJSON = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                // üîí ACTIVER le flag pour emp√™cher la sauvegarde automatique
                setIsLoadingFromDrive(true);
                
                const data = JSON.parse(e.target.result);
                
                // Charger les donn√©es
                if (data.parcelles) setParcelles(data.parcelles);
                if (data.operateurs) setOperateurs(data.operateurs);
                if (data.machines) setMachines(data.machines);
                if (data.produits) setProduitsDisponibles(data.produits);
                if (data.lotsParProduit) setLotsParProduit(data.lotsParProduit);
                
                // Initialiser la m√©moire des lots si n√©cessaire
                if (!data.lotsParProduit && data.parcelles) {
                    initialiserMemoireLots(data.parcelles);
                }
                
                showToast('‚úÖ Fichier JSON import√© avec succ√®s !');
                
                // Sauvegarder imm√©diatement sur Google Drive si connect√©
                // MAIS seulement apr√®s avoir d√©sactiv√© le flag
                if (googleAccessToken) {
                    setTimeout(() => {
                        setIsLoadingFromDrive(false);
                        sauvegarderSurDrive();
                        console.log('üíæ Sauvegarde post-import JSON effectu√©e');
                    }, 500);
                } else {
                    // Si pas connect√©, d√©sactiver le flag quand m√™me
                    setTimeout(() => {
                        setIsLoadingFromDrive(false);
                    }, 500);
                }
            } catch (error) {
                console.error('Erreur import JSON:', error);
                setIsLoadingFromDrive(false); // D√©sactiver m√™me en cas d'erreur
                showToast('‚ùå Erreur lors de l\'import du fichier JSON', 'error');
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset input
    };

    const changerAnnee = async (nouvelleAnnee) => {
        if (!verifierModificationAutorisee()) return;
        
        // ‚≠ê SAUVEGARDER l'ann√©e actuelle AVANT de changer (si connect√© √† Drive)
        if (googleAccessToken && autoSyncEnabled) {
            console.log('üíæ Sauvegarde de l\'ann√©e actuelle avant changement...');
            try {
                await sauvegarderSurDrive();
                console.log('‚úÖ Ann√©e actuelle sauvegard√©e');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde avant changement ann√©e:', error);
                const confirmer = confirm(
                    '‚ö†Ô∏è Impossible de sauvegarder l\'ann√©e actuelle.\n\n' +
                    'Si vous continuez, les modifications non sauvegard√©es seront perdues.\n\n' +
                    'Continuer quand m√™me ?'
                );
                if (!confirmer) {
                    return; // Annuler le changement d'ann√©e
                }
            }
        }
        
        setAnnee(nouvelleAnnee);
        
        // Si connect√© √† Google Drive, charger la nouvelle ann√©e
        if (googleAccessToken) {
            showToast(`üìÖ Ann√©e chang√©e : ${nouvelleAnnee}. Chargement des donn√©es...`);
            // Passer directement la nouvelle ann√©e √† chargerDepuisDrive
            setTimeout(async () => {
                await chargerDepuisDrive(googleAccessToken, nouvelleAnnee);
            }, 100);
        } else {
            // Si pas connect√©, r√©initialiser l'√©tat local
            const data = loadData();
            setParcelles(data.parcelles);
            setOperateurs(data.operateurs);
            setMachines(data.machines);
            setLotsParProduit({});
            setDerniereCopie(null);
            showToast(`üìÖ Ann√©e chang√©e : ${nouvelleAnnee}`);
        }
    };

    // R√©initialiser les parcelles
    // Gestion des produits
    const ajouterProduitListe = () => {
        const nom = prompt('Nom du produit :');
        if (!nom || !nom.trim()) return;
        
        const doseRef = prompt('Dose de r√©f√©rence :');
        if (!doseRef) return;
        
        const unite = prompt('Unit√© (kg/ha, L/ha ou L/hl) :', 'L/ha');
        if (!unite) return;
        
        const categorie = prompt('Cat√©gorie (Fongicide, Insecticide, Herbicide ou Autre) :', 'Fongicide');
        if (!categorie) return;
        
        const nouveauProduit = {
            nom: nom.trim(),
            doseRef: parseNumberFR(doseRef),
            unite: unite.trim(),
            categorie: categorie.trim()
        };
        
        setProduitsDisponibles([...produitsDisponibles, nouveauProduit]);
        showToast(`Produit "${nom}" ajout√©`);
    };

    const modifierProduitListe = (index) => {
        const produit = produitsDisponibles[index];
        
        const nom = prompt('Nom du produit :', produit.nom);
        if (nom === null) return;
        
        const doseRef = prompt('Dose de r√©f√©rence :', produit.doseRef);
        if (doseRef === null) return;
        
        const unite = prompt('Unit√© :', produit.unite);
        if (unite === null) return;
        
        const categorie = prompt('Cat√©gorie :', produit.categorie);
        if (categorie === null) return;
        
        const nouveauxProduits = [...produitsDisponibles];
        nouveauxProduits[index] = {
            nom: nom.trim(),
            doseRef: parseNumberFR(doseRef),
            unite: unite.trim(),
            categorie: categorie.trim()
        };
        
        setProduitsDisponibles(nouveauxProduits);
        showToast('Produit modifi√©');
    };

    const supprimerProduitListe = (index) => {
        const produit = produitsDisponibles[index];
        if (confirm(`Supprimer le produit "${produit.nom}" ?`)) {
            setProduitsDisponibles(produitsDisponibles.filter((_, i) => i !== index));
            showToast(`Produit "${produit.nom}" supprim√©`);
        }
    };
    
    // Ajouter une parcelle
    const ajouterParcelle = (ilot) => {
        const nouveauNom = prompt(`Nom de la nouvelle parcelle pour ${ilot} :`);
        if (nouveauNom && nouveauNom.trim()) {
            const maxId = Math.max(...parcelles.map(p => p.id), 0);
            const nouvelleParcelle = {
                id: maxId + 1,
                ilot: ilot,
                nom: nouveauNom.trim(),
                surface: '',
                traitements: []
            };
            setParcelles([...parcelles, nouvelleParcelle]);
            showToast(`Parcelle "${nouveauNom}" ajout√©e √† ${ilot}`);
        }
    };

    // Modifier le nom d'une parcelle
    const modifierNomParcelle = (parcelleId) => {
        const parcelle = parcelles.find(p => p.id === parcelleId);
        if (!parcelle) return;
        
        const nouveauNom = prompt(`Nouveau nom pour "${parcelle.nom}" :`, parcelle.nom);
        if (nouveauNom && nouveauNom.trim() && nouveauNom !== parcelle.nom) {
            setParcelles(parcelles.map(p => 
                p.id === parcelleId ? { ...p, nom: nouveauNom.trim() } : p
            ));
            showToast(`Parcelle renomm√©e en "${nouveauNom}"`);
        }
    };

    // Supprimer une parcelle
    const supprimerParcelle = (parcelleId) => {
        const parcelle = parcelles.find(p => p.id === parcelleId);
        if (!parcelle) return;
        
        const nbTraitements = parcelle.traitements.length;
        const message = nbTraitements > 0 
            ? `‚ö†Ô∏è Supprimer la parcelle "${parcelle.nom}" ?\n\nCette parcelle contient ${nbTraitements} traitement(s) qui seront √©galement supprim√©s.`
            : `Supprimer la parcelle "${parcelle.nom}" ?`;
        
        if (confirm(message)) {
            setParcelles(parcelles.filter(p => p.id !== parcelleId));
            showToast(`Parcelle "${parcelle.nom}" supprim√©e`);
        }
    };

    // ========== GOOGLE DRIVE SYNC ==========
    const CLIENT_ID = '447944911998-ranpvgutp8qvtr7m6mkrlr0t28a8f81e.apps.googleusercontent.com';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const SHARED_FOLDER_NAME = 'Registre_Phytosanitaire_Partage'; // Nom du dossier partag√©

    // Connexion √† Google Drive
    const connecterGoogleDrive = () => {
        try {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        setGoogleAccessToken(response.access_token);
                        setGoogleDriveConnected(true);
                        setModeReadOnly(false);
                        setAutoSyncEnabled(true);
                        showToast('‚úÖ Connect√© √† Google Drive ! (Sync auto activ√©e)');
                        
                        // Initialiser le dossier de mani√®re asynchrone apr√®s la connexion
                        setTimeout(() => {
                            initialiserDossierPartage(response.access_token);
                            chargerDepuisDrive(response.access_token);
                        }, 100);
                    }
                },
            });
            tokenClient.requestAccessToken();
        } catch (error) {
            console.error('Erreur connexion:', error);
            showToast('Erreur lors de la connexion', 'error');
        }
    };

    // D√©connexion de Google Drive
    const deconnecterGoogleDrive = () => {
        if (googleAccessToken) {
            google.accounts.oauth2.revoke(googleAccessToken);
            setGoogleAccessToken(null);
            setGoogleDriveConnected(false);
            setAutoSyncEnabled(false);
            setSharedFolderId(null);
            showToast('D√©connect√© de Google Drive');
        }
    };

    // Initialiser le dossier partag√©
    const initialiserDossierPartage = async (token) => {
        try {
            // Chercher si le dossier existe d√©j√†
            const searchResponse = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=name='${SHARED_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                {
                    headers: { 'Authorization': `Bearer ${token}` }
                }
            );
            
            const searchData = await searchResponse.json();
            
            if (searchData.files && searchData.files.length > 0) {
                // Dossier trouv√©
                setSharedFolderId(searchData.files[0].id);
                console.log('Dossier partag√© trouv√©:', searchData.files[0].id);
            } else {
                // Cr√©er le dossier
                const createResponse = await fetch(
                    'https://www.googleapis.com/drive/v3/files',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: SHARED_FOLDER_NAME,
                            mimeType: 'application/vnd.google-apps.folder'
                        })
                    }
                );
                
                const createData = await createResponse.json();
                setSharedFolderId(createData.id);
                console.log('Dossier partag√© cr√©√©:', createData.id);
                
                showToast('üìÅ Dossier partag√© cr√©√© dans Google Drive');
            }
        } catch (error) {
            console.error('Erreur initialisation dossier:', error);
            showToast('Erreur lors de l\'initialisation du dossier', 'error');
        }
    };

    // Charger les donn√©es depuis Google Drive
    const chargerDepuisDrive = async (token, anneeACharger = null) => {
        try {
            // üîí ACTIVER le flag pour emp√™cher la sauvegarde automatique
            setIsLoadingFromDrive(true);
            
            console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîµ D√âBUT CHARGEMENT GOOGLE DRIVE');
            console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Utiliser l'ann√©e pass√©e en param√®tre ou l'ann√©e actuelle
            const anneeUtilisee = anneeACharger !== null ? anneeACharger : annee;
            const fileName = `Phyto_${anneeUtilisee}.json`;
            
            // SOLUTION TEMPORAIRE: Si on cherche 2025 et qu'on ne trouve rien, essayer l'ID connu
            const FILE_ID_2025 = '1hs8XfXBGXI3sN1Vx2JsHW1lPPGnMbPOK';
            
            // Si on a le dossier partag√©, chercher dedans sp√©cifiquement
            const searchQuery = sharedFolderId 
                ? `name='${fileName}' and '${sharedFolderId}' in parents and trashed=false`
                : `name='${fileName}' and trashed=false`;
            
            console.log('üîç Recherche fichier:', fileName);
            console.log('üìÖ Ann√©e utilis√©e:', anneeUtilisee);
            console.log('üìÅ Dossier partag√© ID:', sharedFolderId);
            console.log('üîé Requ√™te:', searchQuery);
            
            // DEBUG: Lister TOUS les fichiers du dossier
            if (sharedFolderId) {
                const listAllResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q='${sharedFolderId}' in parents and trashed=false`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const allFiles = await listAllResponse.json();
                console.log('üìÇ TOUS les fichiers du dossier:', allFiles.files);
            }
            
            const searchResponse = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=${searchQuery}`,
                {
                    headers: { 'Authorization': `Bearer ${token}` }
                }
            );
            
            const searchData = await searchResponse.json();
            console.log('üìã R√©sultats recherche:', searchData);
            
            let fileId = null;
            
            if (searchData.files && searchData.files.length > 0) {
                console.log('‚úÖ Fichier trouv√©:', searchData.files[0]);
                fileId = searchData.files[0].id;
                console.log('üìÇ CHARGEMENT depuis FileId:', fileId);
                console.log('üìÇ Nom du fichier:', searchData.files[0].name);
            } else if (anneeUtilisee === 2025 && FILE_ID_2025) {
                // Solution de contournement pour 2025
                console.log('üí° Tentative de chargement avec ID direct pour 2025');
                fileId = FILE_ID_2025;
            }
            
            if (fileId) {
                // T√©l√©charger le fichier
                const downloadResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }
                );
                
                const data = await downloadResponse.json();
                
                console.log('üì• Donn√©es charg√©es depuis Drive:');
                console.log('  üìÇ Parcelles:', data.parcelles?.length || 0);
                console.log('  üë§ Op√©rateurs:', data.operateurs || []);
                console.log('  üöú Machines:', data.machines?.length || 0);
                console.log('  üß™ Produits:', data.produits?.length || 0);
                console.log('  üè∑Ô∏è Lots m√©moris√©s:', Object.keys(data.lotsParProduit || {}).length);
                console.log('  üìÖ LastUpdate:', data.lastUpdate);
                console.log('  ‚è±Ô∏è SaveTimestamp:', data.saveTimestamp);
                
                // Charger les donn√©es
                if (data.parcelles) {
                    console.log('üì¶ Chargement des parcelles...');
                    setParcelles(data.parcelles);
                }
                if (data.operateurs) {
                    console.log('üë§ Chargement des op√©rateurs...');
                    setOperateurs(data.operateurs);
                }
                if (data.machines) {
                    console.log('üöú Chargement des machines...');
                    setMachines(data.machines);
                }
                if (data.produits) {
                    console.log('üß™ Chargement des produits...');
                    setProduitsDisponibles(data.produits);
                }
                if (data.lotsParProduit) {
                    console.log('üè∑Ô∏è Chargement de la m√©moire des lots...');
                    setLotsParProduit(data.lotsParProduit);
                } else if (data.parcelles) {
                    console.log('üè∑Ô∏è Initialisation de la m√©moire des lots...');
                    // Si pas de m√©moire de lots sauvegard√©e, scanner les traitements existants
                    initialiserMemoireLots(data.parcelles);
                }
                
                showToast('üì• Donn√©es charg√©es depuis Google Drive');
                
                console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üîµ FIN CHARGEMENT GOOGLE DRIVE - SUCC√àS');
                console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            } else {
                // Fichier non trouv√©
                console.log('‚ùå Fichier non trouv√©');
                console.log('üí° Cr√©ation d\'un nouveau fichier pour cette ann√©e avec la structure actuelle');
                
                // ‚≠ê Cr√©er un fichier pour la nouvelle ann√©e avec les parcelles/produits actuels
                // mais sans traitements (ann√©e vierge)
                const parcellesVierges = parcelles.map(p => ({
                    ...p,
                    traitements: [] // Ann√©e vierge = pas de traitements
                }));
                
                setParcelles(parcellesVierges);
                setLotsParProduit({});
                
                // Sauvegarder imm√©diatement ce fichier vierge
                setTimeout(async () => {
                    console.log('üíæ Cr√©ation du fichier vierge pour', anneeUtilisee);
                    await sauvegarderSurDrive();
                }, 500);
                
                showToast(`üìÖ Nouvelle ann√©e ${anneeUtilisee} cr√©√©e (structure conserv√©e, traitements vides)`);
            }
            
            // üîì D√âSACTIVER le flag apr√®s 3 secondes pour permettre la sauvegarde
            setTimeout(() => {
                setIsLoadingFromDrive(false);
                console.log('üîì Flag isLoadingFromDrive d√©sactiv√© - sauvegarde auto r√©activ√©e');
            }, 3000);
            
        } catch (error) {
            console.error('‚ùå ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.error('‚ùå ERREUR CHARGEMENT GOOGLE DRIVE:', error);
            console.error('‚ùå ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            showToast('Erreur lors du chargement', 'error');
            // D√©sactiver le flag m√™me en cas d'erreur
            setIsLoadingFromDrive(false);
            // Pas de toast d'erreur si le fichier n'existe pas encore
        }
    };

    // Initialiser la m√©moire des lots en scannant tous les traitements existants
    const initialiserMemoireLots = (parcellesData = parcelles) => {
        const nouveauxLots = {};
        let nbLotsInitialises = 0;
        
        parcellesData.forEach(parcelle => {
            parcelle.traitements.forEach(traitement => {
                traitement.produits.forEach(produit => {
                    if (produit.produit && produit.numeroLot && produit.numeroLot.trim()) {
                        // M√©moriser le lot (le dernier rencontr√© √©crase les pr√©c√©dents)
                        nouveauxLots[produit.produit] = produit.numeroLot.trim();
                        nbLotsInitialises++;
                    }
                });
            });
        });
        
        setLotsParProduit(nouveauxLots);
        
        if (nbLotsInitialises > 0) {
            const nbProduitsUniques = Object.keys(nouveauxLots).length;
            showToast(`üîñ ${nbProduitsUniques} num√©ro(s) de lot initialis√©(s) en m√©moire`);
        }
        
        return nouveauxLots;
    };

    // Sauvegarder sur Google Drive (dossier partag√©)
    const sauvegarderSurDrive = async () => {
        if (!googleAccessToken || !sharedFolderId) {
            showToast('Connectez-vous d\'abord √† Google Drive', 'error');
            return;
        }
        
        // üîí Emp√™cher les sauvegardes simultan√©es
        if (isSaving) {
            console.log('‚è∏Ô∏è Sauvegarde d√©j√† en cours, ignor√©e pour √©viter race condition');
            return;
        }
        
        setIsSaving(true);
        console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üîµ D√âBUT SAUVEGARDE GOOGLE DRIVE');
        console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

        try {
            const data = { 
                parcelles, 
                operateurs, 
                machines,
                produits: produitsDisponibles,
                lotsParProduit,
                lastUpdate: new Date().toISOString(),
                saveTimestamp: Date.now(), // ‚≠ê Timestamp pour v√©rification
                updatedBy: 'user'
            };
            
            // üìä Logs d√©taill√©s des donn√©es
            console.log('üì¶ Donn√©es √† sauvegarder:');
            console.log('  üìÇ Parcelles:', parcelles.length);
            console.log('  üë§ Op√©rateurs:', operateurs);
            console.log('  üöú Machines:', machines.length);
            console.log('  üß™ Produits disponibles:', produitsDisponibles.length);
            console.log('  üè∑Ô∏è Lots m√©moris√©s:', Object.keys(lotsParProduit).length);
            console.log('  üìä Taille totale:', JSON.stringify(data).length, 'caract√®res');
            
            const jsonData = JSON.stringify(data, null, 2);
            const fileName = `Phyto_${annee}.json`;
            
            console.log('üìù Nom du fichier:', fileName);
            
            // Chercher si le fichier existe d√©j√†
            const searchResponse = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=name='${fileName}' and '${sharedFolderId}' in parents and trashed=false`,
                {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                }
            );
            
            const searchData = await searchResponse.json();
            
            if (searchData.files && searchData.files.length > 0) {
                // Mettre √† jour le fichier existant
                const fileId = searchData.files[0].id;
                console.log('üìù MISE √Ä JOUR fichier existant');
                console.log('üìù FileId:', fileId);
                console.log('üìù Nom:', searchData.files[0].name);
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({ name: fileName })], { type: 'application/json' }));
                form.append('file', new Blob([jsonData], { type: 'application/json' }));

                const response = await fetch(
                    `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        },
                        body: form
                    }
                );

                if (response.ok) {
                    console.log('‚úÖ Sauvegarde r√©ussie - Fichier mis √† jour');
                    showToast('‚úÖ Synchronis√© avec Google Drive');
                    // ‚≠ê R√©initialiser le compteur d'√©checs en cas de succ√®s
                    setSaveFailureCount(0);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur r√©ponse:', response.status, errorText);
                    throw new Error('Erreur de mise √† jour');
                }
            } else {
                // Cr√©er un nouveau fichier
                console.log('üìù CR√âATION nouveau fichier');
                const metadata = {
                    name: fileName,
                    mimeType: 'application/json',
                    parents: [sharedFolderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([jsonData], { type: 'application/json' }));

                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        },
                        body: form
                    }
                );

                if (response.ok) {
                    const newFileData = await response.json();
                    console.log('‚úÖ Sauvegarde r√©ussie - Nouveau fichier cr√©√©');
                    console.log('üìù Nouveau FileId:', newFileData.id);
                    showToast('‚úÖ Sauvegard√© sur Google Drive');
                    // ‚≠ê R√©initialiser le compteur d'√©checs en cas de succ√®s
                    setSaveFailureCount(0);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur r√©ponse:', response.status, errorText);
                    throw new Error('Erreur de sauvegarde');
                }
            }
            
            console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîµ FIN SAUVEGARDE GOOGLE DRIVE - SUCC√àS');
            console.log('üîµ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
        } catch (error) {
            console.error('‚ùå ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.error('‚ùå ERREUR SAUVEGARDE GOOGLE DRIVE:', error);
            console.error('‚ùå ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // ‚≠ê Incr√©menter le compteur d'√©checs
            setSaveFailureCount(prev => {
                const newCount = prev + 1;
                console.warn(`‚ö†Ô∏è √âchec de sauvegarde n¬∞${newCount}`);
                
                // ‚≠ê Alerte critique apr√®s 3 √©checs
                if (newCount >= 3) {
                    setModeReadOnly(true);
                    setAutoSyncEnabled(false);
                    showToast('üî¥ ALERTE : 3 √©checs de sauvegarde ! V√©rifiez votre connexion et reconnectez-vous.', 'error');
                }
                
                return newCount;
            });
            
            // D√©tecter expiration token
            const errorMessage = error.message || '';
            if (errorMessage.includes('401') || errorMessage.includes('Invalid')) {
                setModeReadOnly(true);
                setAutoSyncEnabled(false);
                showToast('TOKEN EXPIR√â - Mode lecture seule activ√©. Reconnectez-vous.', 'error');
            } else {
                showToast('‚ùå Erreur lors de la sauvegarde', 'error');
            }
        } finally {
            // üîì Lib√©rer le flag de sauvegarde
            setIsSaving(false);
            console.log('üîì Flag isSaving lib√©r√©');
        }
    };

    // Recharger les donn√©es depuis Drive manuellement
    const rechargerDepuisDrive = async () => {
        if (!googleAccessToken) {
            showToast('Connectez-vous d\'abord √† Google Drive', 'error');
            return;
        }
        
        await chargerDepuisDrive(googleAccessToken);
    };

    // Nettoyer les doublons de produits dans les traitements
    const nettoyerDoublonsProduits = () => {
        console.log('üßπ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üßπ D√âBUT NETTOYAGE ET R√âORGANISATION');
        console.log('üßπ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        let nbDoublonsTrouves = 0;
        let nbTraitementsModifies = 0;
        let nbReclassifies = 0;
        let nbParcellesTriees = 0;
        
        const parcellesNettoyees = parcelles.map(parcelle => {
            // √âtape 1 : Nettoyer les doublons dans chaque traitement
            let traitements = parcelle.traitements.map(traitement => {
                const produitsUniques = [];
                const vus = new Set();
                let doublonsDansCeTraitement = 0;
                
                traitement.produits.forEach(produit => {
                    // Cr√©er une cl√© unique : nom + lot + dose
                    const cle = `${produit.produit}|${produit.numeroLot}|${produit.doseHa}`;
                    
                    if (!vus.has(cle)) {
                        vus.add(cle);
                        produitsUniques.push(produit);
                    } else {
                        nbDoublonsTrouves++;
                        doublonsDansCeTraitement++;
                        console.log(`  üóëÔ∏è Doublon supprim√©: ${produit.produit} (lot: ${produit.numeroLot}, dose: ${produit.doseHa})`);
                    }
                });
                
                if (doublonsDansCeTraitement > 0) {
                    nbTraitementsModifies++;
                    console.log(`  üìã Traitement du ${traitement.date} dans ${parcelle.nom}: ${doublonsDansCeTraitement} doublon(s) supprim√©(s)`);
                }
                
                return {
                    ...traitement,
                    produits: produitsUniques
                };
            });
            
            // √âtape 2 : Reclassifier les traitements contenant des herbicides
            traitements = traitements.map(traitement => {
                const aDesHerbicides = traitement.produits.some(p => {
                    const produitInfo = produitsDisponibles.find(pd => pd.nom === p.produit);
                    return produitInfo && produitInfo.categorie === 'Herbicide';
                });
                
                if (aDesHerbicides && traitement.type !== 'desherbage') {
                    nbReclassifies++;
                    console.log(`  üîÑ Reclassification: Traitement ‚Üí D√©sherbage (${traitement.date} dans ${parcelle.nom})`);
                    return { ...traitement, type: 'desherbage' };
                }
                return traitement;
            });
            
            // √âtape 3 : Trier chronologiquement (plus ancien en premier)
            const traitementsTries = [...traitements].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });
            
            // V√©rifier si l'ordre a chang√©
            const ordreChange = traitements.some((t, idx) => t.id !== traitementsTries[idx].id);
            if (ordreChange && traitements.length > 0) {
                nbParcellesTriees++;
                console.log(`  üìÖ Tri chronologique: ${parcelle.nom} (${traitements.length} traitement(s))`);
            }
            
            return {
                ...parcelle,
                traitements: traitementsTries
            };
        });
        
        // R√©sum√© et sauvegarde
        const actionsEffectuees = [];
        if (nbDoublonsTrouves > 0) actionsEffectuees.push(`${nbDoublonsTrouves} doublon(s) supprim√©(s)`);
        if (nbReclassifies > 0) actionsEffectuees.push(`${nbReclassifies} reclassification(s)`);
        if (nbParcellesTriees > 0) actionsEffectuees.push(`${nbParcellesTriees} parcelle(s) tri√©e(s)`);
        
        if (actionsEffectuees.length > 0) {
            setParcelles(parcellesNettoyees);
            console.log('üìä R√©sum√© du nettoyage:');
            console.log(`  üóëÔ∏è Doublons supprim√©s: ${nbDoublonsTrouves}`);
            console.log(`  üîÑ Reclassifications: ${nbReclassifies}`);
            console.log(`  üìÖ Parcelles tri√©es: ${nbParcellesTriees}`);
            console.log('üßπ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üßπ FIN NETTOYAGE - SUCC√àS');
            console.log('üßπ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            showToast(`üßπ ${actionsEffectuees.join(', ')}`);
            
            // Note: La sauvegarde automatique se d√©clenchera via le useEffect
            // car les parcelles ont √©t√© modifi√©es (d√©lai 1 minute)
            console.log('‚ÑπÔ∏è La sauvegarde automatique se d√©clenchera dans 1 minute');
        } else {
            console.log('‚úÖ Aucune action n√©cessaire - Donn√©es d√©j√† propres et organis√©es');
            console.log('üßπ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            showToast('‚úÖ Donn√©es d√©j√† propres et organis√©es');
        }
    };

    // Auto-sync toutes les 5 minutes
    useEffect(() => {
        if (autoSyncEnabled && googleDriveConnected && sharedFolderId) {
            const interval = setInterval(() => {
                // V√©rifier les flags avant de sauvegarder
                if (!isLoadingFromDrive && !isSaving) {
                    console.log('üíæ Sauvegarde p√©riodique (toutes les 5 minutes)');
                    sauvegarderSurDrive();
                } else {
                    console.log('‚è∏Ô∏è Sauvegarde p√©riodique ignor√©e - op√©ration en cours');
                }
            }, 5 * 60 * 1000); // 5 minutes

            return () => clearInterval(interval);
        }
    }, [autoSyncEnabled, googleDriveConnected, sharedFolderId]); // ‚≠ê Retir√©: parcelles, operateurs, machines

    // Sauvegarder automatiquement √† chaque modification si auto-sync est activ√©
    useEffect(() => {
        // üîí NE PAS sauvegarder si on est en train de charger depuis Drive
        if (isLoadingFromDrive) {
            console.log('‚è∏Ô∏è Sauvegarde auto suspendue - chargement en cours');
            return;
        }
        
        // üîí NE PAS sauvegarder si une sauvegarde est d√©j√† en cours
        if (isSaving) {
            console.log('‚è∏Ô∏è Sauvegarde auto suspendue - sauvegarde en cours');
            return;
        }
        
        if (autoSyncEnabled && googleDriveConnected && sharedFolderId) {
            const timeoutId = setTimeout(() => {
                // V√©rifier √† nouveau les flags au moment de la sauvegarde
                if (!isLoadingFromDrive && !isSaving) {
                    console.log('üíæ Sauvegarde automatique d√©clench√©e (d√©lai 1 minute √©coul√©)');
                    sauvegarderSurDrive();
                } else {
                    console.log('‚è∏Ô∏è Sauvegarde automatique annul√©e - op√©ration en cours');
                }
            }, 60000); // ‚≠ê 1 minute apr√®s la derni√®re modification

            return () => clearTimeout(timeoutId);
        }
    }, [parcelles, operateurs, machines, produitsDisponibles, lotsParProduit, isLoadingFromDrive, isSaving]);
    
    // Fermer les suggestions quand on clique √† l'ext√©rieur
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                setShowSuggestions({});
            }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
    }, []);

    // Fonction utilitaire pour parser les nombres avec virgule ou point comme s√©parateur d√©cimal
    const parseNumberFR = (value) => {
        if (!value) return 0;
        // Remplacer la virgule par un point pour parseFloat
        const normalized = String(value).replace(',', '.');
        const num = parseFloat(normalized);
        return isNaN(num) ? 0 : num;
    };

    // Calcul de l'IFT pour un produit
    const calculerIFT = (produit, doseUtilisee) => {
        if (!produit || !doseUtilisee) return 0;
        
        const produitInfo = produitsDisponibles.find(p => p.nom === produit);
        if (!produitInfo || !produitInfo.doseRef) return 0;
        
        // Les adjuvants ne comptent pas dans l'IFT
        if (produitInfo.categorie === 'Adjuvant') return 0;
        
        // Extraire la valeur num√©rique de la dose utilis√©e (accepte virgule et point)
        const doseNum = parseNumberFR(doseUtilisee);
        if (doseNum === 0) return 0;
        
        // IFT = dose utilis√©e / dose de r√©f√©rence
        const ift = doseNum / produitInfo.doseRef;
        return ift;
    };

    // Calcul de l'IFT total pour un traitement
    const calculerIFTTraitement = (produits) => {
        let iftTotal = 0;
        produits.forEach(p => {
            iftTotal += calculerIFT(p.produit, p.doseHa);
        });
        return iftTotal;
    };

    // Calculs statistiques
    const calculerStatistiques = () => {
        let surfaceTotale = 0;
        let nbTraitementsTotal = 0;
        let iftPondere = 0; // Somme des IFT pond√©r√©s par surface
        const produitUtilises = {};
        
        parcelles.forEach(p => {
            const surface = parseNumberFR(p.surface);
            if (surface > 0) surfaceTotale += surface;
            nbTraitementsTotal += p.traitements.length;
            
            p.traitements.forEach(t => {
                // Calcul IFT du traitement
                const iftTraitement = calculerIFTTraitement(t.produits);
                
                // Pond√©rer l'IFT par la surface de la parcelle
                if (surface > 0) {
                    iftPondere += iftTraitement * surface;
                }
                
                t.produits.forEach(pr => {
                    if (pr.produit) {
                        if (!produitUtilises[pr.produit]) {
                            produitUtilises[pr.produit] = { count: 0, surface: 0 };
                        }
                        produitUtilises[pr.produit].count++;
                        if (p.surface) {
                            produitUtilises[pr.produit].surface += surface;
                        }
                    }
                });
            });
        });
        
        // IFT Total = moyenne pond√©r√©e par surface
        const iftTotal = surfaceTotale > 0 ? iftPondere / surfaceTotale : 0;
        
        // Moyenne de traitements par parcelle
        const nbTraitements = parcelles.length > 0 ? nbTraitementsTotal / parcelles.length : 0;
        
        return { surfaceTotale, nbTraitements, iftTotal, produitUtilises };
    };

    const stats = calculerStatistiques();

    // Export CSV
    const exporterCSV = () => {
        // Fonction helper pour √©chapper les valeurs CSV
        const escapeCSV = (value) => {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };
        
        let csv = '';
        
        // ========== FEUILLE 1: TRAITEMENTS DETAILLES ==========
        csv += 'REGISTRE PHYTOSANITAIRE - ANNEE ' + annee + '\n';
        csv += 'TRAITEMENTS DETAILLES PAR PARCELLE\n\n';
        csv += 'Parcelle;Ilot;Surface (ha);Type;N¬∞ Traitement;Date;Produit;N¬∞ Lot;Dose;Unite;IFT;Operateur;Machine;Debit\n';
        
        parcelles.forEach(p => {
            if (p.traitements.length === 0) {
                csv += escapeCSV(p.nom) + ';' + 
                       escapeCSV(p.ilot) + ';' + 
                       escapeCSV(p.surface || '') + ';;;;;;;;;;;;\n';
            } else {
                p.traitements.forEach((t, tIdx) => {
                    const typeTexte = t.type === 'desherbage' ? 'D√©sherbage' : 'Traitement';
                    t.produits.forEach((pr, pIdx) => {
                        const produitInfo = produitsDisponibles.find(pd => pd.nom === pr.produit);
                        const ift = calculerIFT(pr.produit, pr.doseHa);
                        
                        csv += escapeCSV(pIdx === 0 ? p.nom : '') + ';' +
                               escapeCSV(pIdx === 0 ? p.ilot : '') + ';' +
                               escapeCSV(pIdx === 0 ? (p.surface || '') : '') + ';' +
                               escapeCSV(pIdx === 0 ? typeTexte : '') + ';' +
                               escapeCSV(pIdx === 0 ? (tIdx + 1) : '') + ';' +
                               escapeCSV(pIdx === 0 ? t.date : '') + ';' +
                               escapeCSV(pr.produit) + ';' +
                               escapeCSV(pr.numeroLot) + ';' +
                               escapeCSV(pr.doseHa) + ';' +
                               escapeCSV(produitInfo ? produitInfo.unite : '') + ';' +
                               escapeCSV(ift > 0 ? ift.toFixed(3) : '') + ';' +
                               escapeCSV(pIdx === 0 ? t.operateur1 : '') + ';' +
                               escapeCSV(pIdx === 0 ? t.machine : '') + ';' +
                               escapeCSV(pIdx === 0 ? t.debit : '') + '\n';
                    });
                });
            }
        });
        
        csv += '\n\n';
        
        // ========== FEUILLE 2: RESUME PAR PARCELLE ==========
        csv += 'RESUME PAR PARCELLE\n\n';
        csv += 'Parcelle;Ilot;Surface (ha);Nb Traitements;IFT Total\n';
        
        parcelles.forEach(p => {
            let iftParcelle = 0;
            p.traitements.forEach(t => {
                iftParcelle += calculerIFTTraitement(t.produits);
            });
            
            csv += escapeCSV(p.nom) + ';' +
                   escapeCSV(p.ilot) + ';' +
                   escapeCSV(p.surface || '') + ';' +
                   p.traitements.length + ';' +
                   iftParcelle.toFixed(2) + '\n';
        });
        
        csv += '\n\n';
        
        // ========== FEUILLE 3: STATISTIQUES GENERALES ==========
        csv += 'STATISTIQUES GENERALES\n\n';
        csv += 'Indicateur;Valeur\n';
        csv += 'Surface totale traitee;' + stats.surfaceTotale.toFixed(2) + ' ha\n';
        csv += 'Nombre de parcelles;' + parcelles.length + '\n';
        csv += 'Moyenne traitements par parcelle;' + Math.round(stats.nbTraitements) + '\n';
        csv += 'IFT Total;' + stats.iftTotal.toFixed(2) + '\n';
        csv += 'IFT Moyen par hectare;' + (stats.surfaceTotale > 0 ? (stats.iftTotal / stats.surfaceTotale).toFixed(2) : '0') + '\n';
        
        csv += '\n\n';
        
        // ========== FEUILLE 4: CONSOMMATION PRODUITS ==========
        csv += 'CONSOMMATION PAR PRODUIT\n\n';
        csv += 'Produit;Categorie;Nb Utilisations;Surface traitee (ha);Dose reference;Unite\n';
        
        Object.entries(stats.produitUtilises)
            .sort((a, b) => b[1].count - a[1].count)
            .forEach(([produit, data]) => {
                const produitInfo = produitsDisponibles.find(p => p.nom === produit);
                csv += escapeCSV(produit) + ';' +
                       escapeCSV(produitInfo ? produitInfo.categorie : '') + ';' +
                       data.count + ';' +
                       data.surface.toFixed(2) + ';' +
                       escapeCSV(produitInfo ? produitInfo.doseRef : '') + ';' +
                       escapeCSV(produitInfo ? produitInfo.unite : '') + '\n';
            });
        
        csv += '\n\n';
        
        // ========== FEUILLE 5: OPERATEURS ET MACHINES ==========
        csv += 'OPERATEURS DECLARES\n\n';
        csv += 'N¬∞;Nom\n';
        operateurs.forEach((op, i) => {
            if (op && op.trim() !== '') {
                csv += (i + 1) + ';' + escapeCSV(op) + '\n';
            }
        });
        
        csv += '\n\n';
        csv += 'MACHINES UTILISEES\n\n';
        csv += 'N¬∞;Nom;Vitesse (km/h)\n';
        machines.forEach((m, i) => {
            if (m.nom && m.nom.trim() !== '') {
                csv += (i + 1) + ';' +
                       escapeCSV(m.nom) + ';' +
                       escapeCSV(m.vitesse) + '\n';
            }
        });
        
        // T√©l√©charger le fichier
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `Registre_Phyto_${annee}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Export CSV r√©ussi !');
    };

    // Import CSV
    const importerCSV = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                let csv = e.target.result;
                
                // Supprimer le BOM UTF-8 si pr√©sent
                if (csv.charCodeAt(0) === 0xFEFF) {
                    csv = csv.substring(1);
                }
                
                const lines = csv.split('\n');
                
                console.log('üìÑ Total lignes CSV:', lines.length);
                console.log('üìÑ Premi√®res lignes:', lines.slice(0, 10));
                
                // D√©tecter le s√©parateur (virgule ou point-virgule)
                let separator = ',';
                for (let line of lines) {
                    if (line.includes(';')) {
                        separator = ';';
                        break;
                    }
                }
                console.log('üîç S√©parateur d√©tect√©:', separator);
                
                // Chercher la ligne d'en-t√™te (commence par "Parcelle")
                let startIndex = -1;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('Parcelle') && line.includes('Ilot')) {
                        startIndex = i + 1; // Ligne suivante pour commencer
                        console.log('‚úÖ En-t√™te trouv√© √† la ligne', i, ':', line.substring(0, 50));
                        break;
                    }
                }
                
                if (startIndex === -1) {
                    console.error('‚ùå En-t√™te non trouv√©');
                    console.log('Lignes commen√ßant par P:', 
                        lines.map((l, i) => ({ligne: i, contenu: l.substring(0, 30)}))
                            .filter(x => x.contenu.trim().startsWith('P'))
                    );
                    showToast('Format CSV invalide - En-t√™te non trouv√©', 'error');
                    return;
                }
                
                console.log('üìç D√©but analyse √† la ligne', startIndex);
                
                // Parser les lignes de traitement
                const parseCSVLine = (line, sep) => {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                current += '"';
                                i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === sep && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current);
                    return result;
                };
                
                // R√©initialiser les parcelles
                const newParcelles = initParcelles();
                const traitementsByParcelle = {};
                
                let lignesValides = 0;
                let currentParcelle = '';
                let currentDate = '';
                
                // Cr√©er un mapping inverse : numeroLot -> produit
                const lotToProduit = {};
                Object.entries(lotsParProduit).forEach(([produit, lot]) => {
                    if (lot) lotToProduit[lot] = produit;
                });
                console.log('üîñ Mapping lots -> produits:', lotToProduit);
                
                // Parcourir les lignes
                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const cols = parseCSVLine(line, separator);
                    
                    // Si la premi√®re colonne n'est pas vide, c'est une nouvelle parcelle
                    if (cols[0] && cols[0].trim()) {
                        currentParcelle = cols[0].trim();
                    }
                    
                    // Si la colonne date n'est pas vide, c'est un nouveau traitement
                    if (cols[4] && cols[4].trim()) {
                        currentDate = cols[4].trim();
                    }
                    
                    // Colonnes : Parcelle;Ilot;Surface;N¬∞Traitement;Date;Produit;N¬∞Lot;Dose;Unite;IFT;Operateur;Machine;Debit
                    const parcelleName = currentParcelle;
                    const ilot = cols[1] ? cols[1].trim() : '';
                    const surface = cols[2] ? cols[2].trim() : '';
                    const date = currentDate;
                    let produit = cols[5] ? cols[5].trim() : '';
                    const numeroLot = cols[6] ? cols[6].trim() : '';
                    const dose = cols[7] ? cols[7].trim() : '';
                    const operateur = cols[10] ? cols[10].trim() : '';
                    const machine = cols[11] ? cols[11].trim() : '';
                    const debit = cols[12] ? cols[12].trim() : '';
                    
                    // Si pas de nom de produit mais qu'on a un num√©ro de lot et une dose
                    // ‚Üí Chercher le produit dans la m√©moire des lots
                    if (!produit && numeroLot && dose) {
                        if (lotToProduit[numeroLot]) {
                            produit = lotToProduit[numeroLot];
                            console.log('‚úÖ Produit retrouv√© via lot', numeroLot, '‚Üí', produit);
                        } else {
                            // Produit non trouv√©, on utilise un placeholder
                            produit = `[Produit inconnu - Lot: ${numeroLot}]`;
                            console.warn('‚ö†Ô∏è Ligne', i, ': Lot', numeroLot, 'non trouv√© ‚Üí ajout√© comme "' + produit + '"');
                        }
                    }
                    
                    // Une ligne est valide si elle a au moins une dose, une date et une parcelle
                    // Le produit peut √™tre vide ou un placeholder
                    if (!parcelleName || !date) {
                        continue;
                    }
                    
                    // Si pas de dose ET pas de produit, ignorer (ligne vraiment vide)
                    if (!dose && !produit) {
                        continue;
                    }
                    
                    // Si pas de produit du tout (m√™me apr√®s recherche de lot), mettre un placeholder
                    if (!produit) {
                        produit = '[Produit non sp√©cifi√©]';
                        console.warn('‚ö†Ô∏è Ligne', i, ': Aucun produit ‚Üí ajout√© comme "' + produit + '"');
                    }
                    
                    lignesValides++;
                    
                    // Trouver ou cr√©er le traitement
                    const key = `${parcelleName}-${date}`;
                    
                    if (!traitementsByParcelle[key]) {
                        traitementsByParcelle[key] = {
                            parcelleName,
                            ilot,
                            surface,
                            date,
                            operateur,
                            machine,
                            debit,
                            produits: []
                        };
                    }
                    
                    traitementsByParcelle[key].produits.push({
                        produit,
                        numeroLot,
                        doseHa: dose
                    });
                }
                
                console.log('üìä Lignes valides analys√©es:', lignesValides);
                console.log('üìä Traitements cr√©√©s:', Object.keys(traitementsByParcelle).length);
                console.log('üì¶ Traitements:', traitementsByParcelle);
                
                // Appliquer les traitements aux parcelles
                Object.values(traitementsByParcelle).forEach(t => {
                    const parcelle = newParcelles.find(p => p.nom === t.parcelleName);
                    if (parcelle) {
                        if (t.surface) parcelle.surface = t.surface;
                        parcelle.traitements.push({
                            id: Date.now() + Math.random(),
                            date: t.date,
                            type: 'traitement',
                            produits: t.produits,
                            operateur1: t.operateur,
                            machine: t.machine,
                            debit: t.debit,
                            commentaire: ''
                        });
                    } else {
                        console.warn('‚ö†Ô∏è Parcelle non trouv√©e:', t.parcelleName);
                    }
                });
                
                setParcelles(newParcelles);
                showToast('‚úÖ Import CSV r√©ussi ! ' + Object.keys(traitementsByParcelle).length + ' traitement(s) import√©(s)');
                
            } catch (error) {
                console.error('‚ùå Erreur import:', error);
                showToast('Erreur lors de l\'import CSV', 'error');
            }
        };
        
        reader.readAsText(file, 'UTF-8');
        event.target.value = ''; // Reset input
    };

    const toggleIlot = (ilotNom) => {
        const isCurrentlyOpen = ilotsOuverts.includes(ilotNom);
        
        setIlotsOuverts(prev => 
            prev.includes(ilotNom) 
                ? prev.filter(i => i !== ilotNom)
                : [...prev, ilotNom]
        );
        
        // Si on ferme un √Ælot, scroller vers le premier √Ælot ouvert
        if (isCurrentlyOpen) {
            setTimeout(() => {
                const remainingOpen = ilotsOuverts.filter(i => i !== ilotNom);
                
                if (remainingOpen.length > 0) {
                    // Trouver le premier √Ælot ouvert
                    const firstOpenIlot = ilots.find(ilot => remainingOpen.includes(ilot.nom));
                    if (firstOpenIlot) {
                        // Chercher l'√©l√©ment DOM de cet √Ælot
                        const ilotElements = document.querySelectorAll('.card-glass');
                        for (let element of ilotElements) {
                            const header = element.querySelector('.ilot-header');
                            if (header && header.textContent.includes(firstOpenIlot.nom)) {
                                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                break;
                            }
                        }
                    }
                } else {
                    // Si tous les √Ælots sont ferm√©s, remonter en haut de la liste des √Ælots
                    const firstIlot = document.querySelector('.card-glass');
                    if (firstIlot) {
                        firstIlot.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }, 100); // Petit d√©lai pour que l'animation de fermeture commence
        }
    };

    const ajouterTraitement = (parcelleId) => {
        if (!verifierModificationAutorisee()) return;
        setParcelles(parcelles.map(p => {
            if (p.id === parcelleId && p.traitements.length < 20) {
                return {
                    ...p,
                    traitements: [...p.traitements, {
                        id: Date.now(),
                        date: '',
                        type: 'traitement',
                        produits: [{ produit: '', numeroLot: '', doseHa: '' }],
                        operateur1: '',
                        machine: '',
                        debit: '',
                        commentaire: ''
                    }]
                };
            }
            return p;
        }));
        showToast('Traitement ajout√©');
        setDerniereCopie(null);
    };

    const ajouterDesherbage = (parcelleId) => {
        if (!verifierModificationAutorisee()) return;
        setParcelles(parcelles.map(p => {
            if (p.id === parcelleId && p.traitements.length < 20) {
                return {
                    ...p,
                    traitements: [...p.traitements, {
                        id: Date.now(),
                        date: '',
                        type: 'desherbage',
                        produits: [{ produit: '', numeroLot: '', doseHa: '' }],
                        operateur1: '',
                        machine: '',
                        debit: '',
                        commentaire: ''
                    }]
                };
            }
            return p;
        }));
        showToast('D√©sherbage ajout√©');
        setDerniereCopie(null);
    };

    const supprimerTraitement = (parcelleId, traitementId) => {
        if (!verifierModificationAutorisee()) return;
        if (confirm('Supprimer ce traitement ?')) {
            setParcelles(parcelles.map(p => {
                if (p.id === parcelleId) {
                    return {
                        ...p,
                        traitements: p.traitements.filter(t => t.id !== traitementId)
                    };
                }
                return p;
            }));
            showToast('Traitement supprim√©');
            setDerniereCopie(null);
        }
    };

    const modifierParcelle = (parcelleId, champ, valeur) => {
        setParcelles(parcelles.map(p => 
            p.id === parcelleId ? { ...p, [champ]: valeur } : p
        ));
    };

    const modifierTraitement = (parcelleId, traitementId, champ, valeur) => {
        if (!verifierModificationAutorisee()) return;
        setParcelles(parcelles.map(p => {
            if (p.id === parcelleId) {
                return {
                    ...p,
                    traitements: p.traitements.map(t =>
                        t.id === traitementId ? { ...t, [champ]: valeur } : t
                    )
                };
            }
            return p;
        }));
    };

    const ajouterProduit = (parcelleId, traitementId) => {
        setParcelles(parcelles.map(p => {
            if (p.id === parcelleId) {
                return {
                    ...p,
                    traitements: p.traitements.map(t => {
                        if (t.id === traitementId) {
                            return {
                                ...t,
                                produits: [...t.produits, { produit: '', numeroLot: '', doseHa: '' }]
                            };
                        }
                        return t;
                    })
                };
            }
            return p;
        }));
    };

    const supprimerProduit = (parcelleId, traitementId, produitIdx) => {
        // Nettoyer l'√©tat de recherche pour ce produit
        const key = `${parcelleId}-${traitementId}-${produitIdx}`;
        const newSearchProduit = {...searchProduit};
        delete newSearchProduit[key];
        setSearchProduit(newSearchProduit);
        
        const newShowSuggestions = {...showSuggestions};
        delete newShowSuggestions[key];
        setShowSuggestions(newShowSuggestions);
        
        setParcelles(parcelles.map(p => {
            if (p.id === parcelleId) {
                return {
                    ...p,
                    traitements: p.traitements.map(t => {
                        if (t.id === traitementId) {
                            return {
                                ...t,
                                produits: t.produits.filter((_, idx) => idx !== produitIdx)
                            };
                        }
                        return t;
                    })
                };
            }
            return p;
        }));
    };

    const modifierProduit = (parcelleId, traitementId, produitIdx, champ, valeur) => {
        // Si on modifie le num√©ro de lot, le m√©moriser
        if (champ === 'numeroLot' && valeur && valeur.trim()) {
            // Trouver le produit pour obtenir son nom
            const parcelle = parcelles.find(p => p.id === parcelleId);
            const traitement = parcelle?.traitements.find(t => t.id === traitementId);
            const produit = traitement?.produits[produitIdx];
            
            if (produit && produit.produit) {
                console.log('üè∑Ô∏è M√©morisation lot:', produit.produit, '‚Üí', valeur.trim());
                // ‚≠ê Utiliser la forme fonctionnelle pour avoir l'√©tat le plus r√©cent
                setLotsParProduit(prevLots => ({
                    ...prevLots,
                    [produit.produit]: valeur.trim()
                }));
            }
        }
        
        setParcelles(parcelles.map(p => {
            if (p.id === parcelleId) {
                return {
                    ...p,
                    traitements: p.traitements.map(t => {
                        if (t.id === traitementId) {
                            return {
                                ...t,
                                produits: t.produits.map((prod, idx) =>
                                    idx === produitIdx ? { ...prod, [champ]: valeur } : prod
                                )
                            };
                        }
                        return t;
                    })
                };
            }
            return p;
        }));
    };

    const ouvrirModaleCopie = (parcelleId, traitementId) => {
        const parcelle = parcelles.find(p => p.id === parcelleId);
        const traitement = parcelle.traitements.find(t => t.id === traitementId);
        
        console.log('üîç Validation copie traitement:', traitement);
        console.log('üì¶ Produits:', traitement.produits);
        
        // Validation simple : v√©rifier les champs obligatoires
        const champsManquants = [];
        
        if (!traitement.date) {
            champsManquants.push('Date');
        }
        
        if (!traitement.operateur1) {
            champsManquants.push('Op√©rateur');
        }
        
        if (!traitement.machine) {
            champsManquants.push('Machine');
        }
        
        if (!traitement.debit) {
            champsManquants.push('D√©bit');
        }
        
        // V√©rifier qu'il y a au moins un produit avec un nom
        let aUnProduit = false;
        if (traitement.produits && traitement.produits.length > 0) {
            for (let i = 0; i < traitement.produits.length; i++) {
                const nomProduit = traitement.produits[i].produit;
                console.log('  Produit', i, ':', nomProduit, '| Type:', typeof nomProduit, '| Valide:', !!(nomProduit && nomProduit.trim()));
                if (nomProduit && nomProduit.trim()) {
                    aUnProduit = true;
                    break;
                }
            }
        }
        
        if (!aUnProduit) {
            champsManquants.push('Au moins un produit');
        }
        
        if (champsManquants.length > 0) {
            const message = 'Impossible de copier : champs manquants - ' + champsManquants.join(', ');
            console.error('‚ùå Validation √©chou√©e:', champsManquants);
            showToast(message, 'error');
            return;
        }
        
        console.log('‚úÖ Validation r√©ussie');
        setTraitementACopier({ parcelleId, traitementId, traitement });
        setShowCopyModal(true);
        setParcellesSelectionnees([]);
    };

    const toggleParcelleSelection = (parcelleId) => {
        setParcellesSelectionnees(prev =>
            prev.includes(parcelleId)
                ? prev.filter(id => id !== parcelleId)
                : [...prev, parcelleId]
        );
    };

    const selectionnerToutIlot = (ilotNom) => {
        const parcellesIlot = parcelles
            .filter(p => p.ilot === ilotNom && p.id !== traitementACopier?.parcelleId)
            .map(p => p.id);
        
        const toutesSelectionnees = parcellesIlot.every(id => parcellesSelectionnees.includes(id));
        
        if (toutesSelectionnees) {
            setParcellesSelectionnees(prev => prev.filter(id => !parcellesIlot.includes(id)));
        } else {
            setParcellesSelectionnees(prev => [...new Set([...prev, ...parcellesIlot])]);
        }
    };

    const copierTraitement = () => {
        if (!traitementACopier || parcellesSelectionnees.length === 0) return;

        console.log('üìã ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìã D√âBUT COPIE TRAITEMENT');
        console.log('üìã ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        // Sauvegarder √©tat avant copie
        const etatAvant = JSON.parse(JSON.stringify(parcelles));

        console.log('üìã Traitement ORIGINAL √† copier:');
        console.log('  üìÖ Date:', traitementACopier.traitement.date);
        console.log('  üè∑Ô∏è Type:', traitementACopier.traitement.type);
        console.log('  üë§ Op√©rateur1:', traitementACopier.traitement.operateur1);
        console.log('  üöú Machine:', traitementACopier.traitement.machine);
        console.log('  üíß D√©bit:', traitementACopier.traitement.debit);
        console.log('  üí¨ Commentaire:', traitementACopier.traitement.commentaire);
        console.log('  üß™ Produits:', traitementACopier.traitement.produits);
        
        // Deep copy du traitement pour √©viter les r√©f√©rences partag√©es
        const nouveauTraitement = JSON.parse(JSON.stringify(traitementACopier.traitement));
        nouveauTraitement.id = Date.now();

        console.log('üìã Traitement COPI√â (apr√®s deep copy):');
        console.log('  üìÖ Date:', nouveauTraitement.date);
        console.log('  üè∑Ô∏è Type:', nouveauTraitement.type);
        console.log('  üë§ Op√©rateur1:', nouveauTraitement.operateur1);
        console.log('  üöú Machine:', nouveauTraitement.machine);
        console.log('  üíß D√©bit:', nouveauTraitement.debit);
        console.log('  üí¨ Commentaire:', nouveauTraitement.commentaire);
        console.log('  üß™ Produits:', nouveauTraitement.produits);
        console.log('  üÜî Nouvel ID:', nouveauTraitement.id);
        
        // V√©rification des champs critiques
        if (!nouveauTraitement.operateur1) {
            console.warn('‚ö†Ô∏è ATTENTION: operateur1 est vide dans la copie !');
        }
        if (!nouveauTraitement.debit) {
            console.warn('‚ö†Ô∏è ATTENTION: debit est vide dans la copie !');
        }

        const nouvellesParcelles = parcelles.map(p => {
            if (parcellesSelectionnees.includes(p.id) && p.traitements.length < 20) {
                console.log('  ‚ûï Ajout copie √† parcelle:', p.nom, '(ilot:', p.ilot + ')');
                return {
                    ...p,
                    traitements: [...p.traitements, {
                        ...nouveauTraitement,
                        id: Date.now() + Math.random()
                    }]
                };
            }
            return p;
        });

        setParcelles(nouvellesParcelles);

        // Sauvegarder infos pour annulation
        setDerniereCopie({
            etatAvant: etatAvant,
            nbParcelles: parcellesSelectionnees.length
        });

        const typeTexte = traitementACopier.traitement.type === 'desherbage' ? 'D√©sherbage' : 'Traitement';
        showToast(`${typeTexte} copi√© vers ${parcellesSelectionnees.length} parcelle(s)`);
        
        console.log('üìã ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìã FIN COPIE TRAITEMENT - SUCC√àS');
        console.log('üìã Nombre de parcelles:', parcellesSelectionnees.length);
        console.log('üìã ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        setShowCopyModal(false);
        setTraitementACopier(null);
        setParcellesSelectionnees([]);
    };

    const annulerDerniereCopie = () => {
        if (!derniereCopie) return;
        setParcelles(derniereCopie.etatAvant);
        showToast('Copie annul√©e (' + derniereCopie.nbParcelles + ' parcelles restaur√©es)');
        setDerniereCopie(null);
    };

    // Fonctions pour traitements globaux
    const ouvrirTraitementGlobal = () => {
        setTraitementGlobal({
            date: '',
            produits: [{ produit: '', numeroLot: '', doseHa: '' }],
            operateur1: '',
            machine: '',
            debit: '',
            commentaire: ''
        });
        setParcellesSelectionneesGlobal([]);
        setShowTraitementGlobal(true);
    };

    const ouvrirDesherbageGlobal = () => {
        setTraitementGlobal({
            date: '',
            produits: [{ produit: '', numeroLot: '', doseHa: '' }],
            operateur1: '',
            machine: '',
            debit: '',
            commentaire: ''
        });
        setParcellesSelectionneesGlobal([]);
        setShowDesherbageGlobal(true);
    };

    const appliquerTraitementGlobal = () => {
        if (!verifierModificationAutorisee()) return;
        
        const type = showTraitementGlobal ? 'traitement' : 'desherbage';
        
        // Validation
        if (!traitementGlobal.date) {
            showToast('La date est obligatoire', 'error');
            return;
        }
        if (parcellesSelectionneesglobal.length === 0) {
            showToast('S√©lectionnez au moins une parcelle', 'error');
            return;
        }
        
        const produitsValides = traitementGlobal.produits.filter(p => p.produit && p.doseHa);
        if (produitsValides.length === 0) {
            showToast('Ajoutez au moins un produit avec une dose', 'error');
            return;
        }
        
        // Cr√©er le traitement
        const nouveauTraitement = {
            id: Date.now(),
            date: traitementGlobal.date,
            type: type,
            produits: produitsValides,
            operateur1: traitementGlobal.operateur1 || '',
            machine: traitementGlobal.machine || '',
            debit: traitementGlobal.debit || '',
            commentaire: traitementGlobal.commentaire || ''
        };
        
        // Appliquer aux parcelles s√©lectionn√©es
        const nouvellesParcelles = parcelles.map(p => {
            if (parcellesSelectionneesglobal.includes(p.id) && p.traitements.length < 20) {
                return {
                    ...p,
                    traitements: [...p.traitements, {
                        ...nouveauTraitement,
                        id: Date.now() + Math.random()
                    }]
                };
            }
            return p;
        });
        
        setParcelles(nouvellesParcelles);
        
        const typeTexte = type === 'desherbage' ? 'D√©sherbage' : 'Traitement';
        showToast(`${typeTexte} appliqu√© √† ${parcellesSelectionneesglobal.length} parcelle(s)`);
        
        setShowTraitementGlobal(false);
        setShowDesherbageGlobal(false);
    };

    // Filtrage des parcelles
    const parcellesFiltrees = parcelles.filter(p => {
        if (!searchTerm) return true;
        const term = searchTerm.toLowerCase();
        
        // Recherche par nom de parcelle ou √Ælot
        if (p.nom.toLowerCase().includes(term) || p.ilot.toLowerCase().includes(term)) {
            return true;
        }
        
        // Recherche par produit dans les traitements
        return p.traitements.some(t => 
            t.produits.some(pr => pr.produit.toLowerCase().includes(term))
        );
    });

    return (
        <div className="min-h-screen p-4 md:p-8">
            {toast && (
                <div className={`toast ${toast.type}`}>
                    <div className="flex items-center gap-2">
                        {toast.type === 'success' && <CheckCircle className="text-green-600" />}
                        {toast.type === 'error' && <AlertTriangle className="text-red-600" />}
                        <span className="font-medium">{toast.message}</span>
                    </div>
                </div>
            )}
            
            {/* Alerte √©checs de sauvegarde */}
            {saveFailureCount > 0 && saveFailureCount < 3 && !modeReadOnly && (
                <div className="max-w-7xl mx-auto mb-4">
                    <div className="bg-orange-500 text-white p-4 rounded-lg shadow-xl border-2 border-orange-600">
                        <div className="flex items-center gap-3">
                            <AlertTriangle size={28} />
                            <div className="flex-1">
                                <h3 className="text-lg font-bold mb-1">
                                    ‚ö†Ô∏è √âchec de sauvegarde ({saveFailureCount}/3)
                                </h3>
                                <p className="text-sm">
                                    La derni√®re sauvegarde a √©chou√©. V√©rifiez votre connexion internet.
                                    {saveFailureCount === 2 && " Un √©chec de plus et le mode lecture seule sera activ√© !"}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            {modeReadOnly && (
                <div className="max-w-7xl mx-auto mb-4">
                    <div className="bg-red-600 text-white p-4 rounded-lg shadow-xl border-2 border-red-700">
                        <div className="flex items-center gap-3">
                            <AlertTriangle size={32} />
                            <div className="flex-1">
                                <h3 className="text-xl font-bold mb-1">MODE LECTURE SEULE</h3>
                                <p className="text-sm">
                                    Session Google Drive expir√©e. Toute modification est bloqu√©e.
                                    Reconnectez-vous imm√©diatement.
                                </p>
                            </div>
                            <button
                                onClick={connecterGoogleDrive}
                                className="bg-white text-red-600 px-6 py-3 rounded-lg font-bold hover:bg-red-50">
                                Se reconnecter
                            </button>
                        </div>
                    </div>
                </div>
            )}
            
            <div className="max-w-7xl mx-auto">
                {/* En-t√™te */}
                <div className="card-glass rounded-2xl shadow-2xl p-6 md:p-8 mb-6">
                    <h1 className="header-title text-4xl md:text-5xl font-bold mb-6 text-center">
                        üçá Registre Phytosanitaire
                    </h1>

                    {/* Google Drive Sync */}
                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200 mb-6">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                {googleDriveConnected ? <Cloud className="text-blue-600" /> : <CloudOff className="text-gray-400" />}
                                <span className="font-semibold text-gray-700">
                                    {googleDriveConnected ? '‚òÅÔ∏è Connect√© √† Google Drive' : '‚òÅÔ∏è Google Drive (non connect√©)'}
                                </span>
                            </div>
                            {googleDriveConnected && (
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={autoSyncEnabled}
                                        onChange={(e) => setAutoSyncEnabled(e.target.checked)}
                                        className="w-4 h-4"/>
                                    <span className="text-sm text-gray-600">Sync auto</span>
                                </label>
                            )}
                        </div>
                        <div className="flex flex-col sm:flex-row gap-2">
                            {!googleDriveConnected ? (
                                <button
                                    onClick={connecterGoogleDrive}
                                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2">
                                    <Cloud /> Se connecter
                                </button>
                            ) : (
                                <>
                                    <button
                                        onClick={sauvegarderSurDrive}
                                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-semibold text-sm flex items-center justify-center gap-2">
                                        <Upload size={16} /> Sauvegarder
                                    </button>
                                    <button
                                        onClick={rechargerDepuisDrive}
                                        className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-semibold text-sm flex items-center justify-center gap-2">
                                        <Download size={16} /> Recharger
                                    </button>
                                    <button
                                        onClick={nettoyerDoublonsProduits}
                                        className="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg font-semibold text-sm flex items-center justify-center gap-2"
                                        title="Supprime les produits en double dans les traitements">
                                        üßπ Nettoyer
                                    </button>
                                    <button
                                        onClick={deconnecterGoogleDrive}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-700 px-3 py-2 rounded-lg font-semibold text-sm">
                                        D√©connecter
                                    </button>
                                </>
                            )}
                        </div>
                        {autoSyncEnabled && (
                            <p className="text-xs text-blue-600 mt-2 italic">
                                ‚ö° Synchronisation automatique activ√©e
                            </p>
                        )}
                        {googleDriveConnected && sharedFolderId && (
                            <p className="text-xs text-green-600 mt-2">
                                üìÅ Dossier partag√© : {SHARED_FOLDER_NAME}
                            </p>
                        )}
                    </div>
                    
                    {/* Statistiques */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div className="stat-card">
                            <div className="text-sm opacity-90 mb-1">Surface totale</div>
                            <div className="text-3xl font-bold">{stats.surfaceTotale.toFixed(2)} ha</div>
                        </div>
                        <div className="stat-card">
                            <div className="text-sm opacity-90 mb-1">Traitements / parcelle</div>
                            <div className="text-3xl font-bold">{Math.round(stats.nbTraitements)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="text-sm opacity-90 mb-1">IFT Total</div>
                            <div className="text-3xl font-bold">{stats.iftTotal.toFixed(2)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="text-sm opacity-90 mb-1">Parcelles</div>
                            <div className="text-3xl font-bold">{parcelles.length}</div>
                        </div>
                    </div>

                    {/* Contr√¥les */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Ann√©e</label>
                            <select
                                value={annee}
                                onChange={(e) => changerAnnee(parseInt(e.target.value))}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                {[2023, 2024, 2025, 2026].map(y => (
                                    <option key={y} value={y}>{y}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Op√©rateur 1</label>
                            <input
                                type="text"
                                value={operateurs[0]}
                                onChange={(e) => setOperateurs([e.target.value, operateurs[1]])}
                                placeholder="Nom de l'op√©rateur"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"/>
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Op√©rateur 2</label>
                            <input
                                type="text"
                                value={operateurs[1]}
                                onChange={(e) => setOperateurs([operateurs[0], e.target.value])}
                                placeholder="Nom de l'op√©rateur"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"/>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div className="flex flex-col gap-2">
                            <button
                                onClick={exporterCSV}
                                className="btn-primary w-full text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2">
                                <Download /> Export CSV
                            </button>
                            <label className="btn-primary w-full text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 cursor-pointer">
                                <Upload /> Import CSV
                                <input
                                    type="file"
                                    accept=".csv"
                                    onChange={importerCSV}
                                    className="hidden"/>
                            </label>
                            <label className="bg-indigo-600 hover:bg-indigo-700 w-full text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 cursor-pointer transition-all">
                                <Upload /> Import JSON
                                <input
                                    type="file"
                                    accept=".json"
                                    onChange={importerJSON}
                                    className="hidden"/>
                            </label>
                        </div>
                        <div className="flex items-stretch">
                            {derniereCopie ? (
                                <button
                                    onClick={annulerDerniereCopie}
                                    className="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all hover:shadow-lg">
                                    <Trash2 /> Annuler derni√®re copie
                                </button>
                            ) : (
                                <button
                                    onClick={() => setShowGestionParcelles(true)}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all hover:shadow-lg">
                                    <Settings /> G√©rer les parcelles
                                </button>
                            )}
                        </div>
                        <div className="flex items-stretch">
                            <button
                                onClick={() => setShowGestionProduits(true)}
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all hover:shadow-lg">
                                <Settings /> G√©rer les produits
                            </button>
                        </div>
                    </div>

                    {/* Recherche */}
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                        <input
                            type="text"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            placeholder="Rechercher une parcelle, un √Ælot ou un produit..."
                            className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"/>
                    </div>
                </div>

                {/* Configuration des machines */}
                <div className="card-glass rounded-2xl shadow-xl p-6 mb-6">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">‚öôÔ∏è Machines</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {machines.map((machine, idx) => (
                            <div key={idx} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Machine {idx + 1}</label>
                                <input
                                    type="text"
                                    value={machine.nom}
                                    onChange={(e) => {
                                        const newMachines = [...machines];
                                        newMachines[idx].nom = e.target.value;
                                        setMachines(newMachines);
                                    }}
                                    placeholder="Nom"
                                    className="w-full px-3 py-2 border border-gray-300 rounded mb-2"/>
                                <input
                                    type="text"
                                    value={machine.vitesse}
                                    onChange={(e) => {
                                        const newMachines = [...machines];
                                        newMachines[idx].vitesse = e.target.value;
                                        setMachines(newMachines);
                                    }}
                                    placeholder="Vitesse (km/h)"
                                    className="w-full px-3 py-2 border border-gray-300 rounded"/>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Traitements globaux */}
                <div className="card-glass rounded-2xl shadow-xl p-6 mb-6">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">üåç Traitements globaux</h2>
                    <p className="text-sm text-gray-600 mb-4">
                        Cr√©ez un traitement ou d√©sherbage et appliquez-le √† plusieurs parcelles en une seule fois
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button
                            onClick={ouvrirTraitementGlobal}
                            disabled={modeReadOnly}
                            className="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-4 rounded-lg font-semibold flex items-center justify-center gap-2 text-lg">
                            <Plus size={24} /> Ajouter traitement global
                        </button>
                        <button
                            onClick={ouvrirDesherbageGlobal}
                            disabled={modeReadOnly}
                            className="bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white px-6 py-4 rounded-lg font-semibold flex items-center justify-center gap-2 text-lg">
                            <Plus size={24} /> Ajouter d√©sherbage global
                        </button>
                    </div>
                </div>

                {/* √élots et parcelles */}
                <div className="space-y-4">
                    {ilots.map(ilot => {
                        const parcellesIlot = parcellesFiltrees.filter(p => p.ilot === ilot.nom);
                        if (parcellesIlot.length === 0 && searchTerm) return null;
                        
                        const isOpen = ilotsOuverts.includes(ilot.nom);
                        const nbTraitementsTotal = parcellesIlot.reduce((acc, p) => acc + p.traitements.length, 0);
                        const nbTraitementsMoyen = parcellesIlot.length > 0 ? Math.round(nbTraitementsTotal / parcellesIlot.length) : 0;
                        const surfaceIlot = parcellesIlot.reduce((acc, p) => acc + parseNumberFR(p.surface), 0);
                        
                        return (
                            <div key={ilot.nom} className="card-glass rounded-2xl shadow-xl overflow-hidden">
                                <button
                                    onClick={() => toggleIlot(ilot.nom)}
                                    className="ilot-header w-full px-6 py-4 flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <span className="text-2xl font-bold">{ilot.nom}</span>
                                        <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                                            {parcellesIlot.length} parcelles
                                        </span>
                                        <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                                            {surfaceIlot.toFixed(2)} ha
                                        </span>
                                        <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                                            {nbTraitementsMoyen} trait./parc.
                                        </span>
                                    </div>
                                    {isOpen ? <ChevronUp /> : <ChevronDown />}
                                </button>

                                {isOpen && (
                                    <div className="p-6 space-y-4">
                                        {parcellesIlot.map(parcelle => (
                                            <div key={parcelle.id} className="bg-white rounded-xl p-4 border-2 border-gray-100">
                                                {/* En-t√™te parcelle */}
                                                <div className="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b-2 border-gray-100">
                                                    <div className="flex-1 min-w-[200px]">
                                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Parcelle</label>
                                                        <input
                                                            type="text"
                                                            value={parcelle.nom}
                                                            onChange={(e) => modifierParcelle(parcelle.id, 'nom', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg font-semibold"/>
                                                    </div>
                                                    <div className="w-32">
                                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Surface (ha)</label>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            value={parcelle.surface}
                                                            onChange={(e) => modifierParcelle(parcelle.id, 'surface', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"/>
                                                    </div>
                                                    <div className="flex-shrink-0 flex gap-2">
                                                        <div>
                                                            <label className="block text-sm font-semibold text-gray-700 mb-1">&nbsp;</label>
                                                            <button
                                                                onClick={() => ajouterTraitement(parcelle.id)}
                                                                disabled={parcelle.traitements.length >= 20}
                                                                className="btn-primary text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 disabled:opacity-50">
                                                                <Plus /> Traitement
                                                            </button>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-semibold text-gray-700 mb-1">&nbsp;</label>
                                                            <button
                                                                onClick={() => ajouterDesherbage(parcelle.id)}
                                                                disabled={parcelle.traitements.length >= 20}
                                                                className="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 disabled:opacity-50">
                                                                <Plus /> D√©sherbage
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Liste des traitements */}
                                                {parcelle.traitements.length > 0 ? (
                                                    <div className="space-y-4">
                                                        {[...parcelle.traitements].reverse().map((traitement, traitementIndex) => {
                                                            const iftTotal = calculerIFTTraitement(traitement.produits);
                                                            
                                                            // Num√©rotation chronologique (1 = plus ancien, en bas)
                                                            // On compte depuis le tableau original (non invers√©)
                                                            const indexOriginal = parcelle.traitements.findIndex(t => t.id === traitement.id);
                                                            const traitementsAvant = parcelle.traitements.slice(0, indexOriginal);
                                                            const numeroType = traitement.type === 'desherbage'
                                                                ? traitementsAvant.filter(t => t.type === 'desherbage').length + 1
                                                                : traitementsAvant.filter(t => t.type !== 'desherbage').length + 1;
                                                            
                                                            return (
                                                                <div key={traitement.id} className="traitement-card bg-gray-50 rounded-lg p-4">
                                                                    <div className="flex items-start justify-between mb-3">
                                                                        <div className="flex items-center gap-3">
                                                                            <div className={`${traitement.type === 'desherbage' ? 'bg-orange-600' : 'bg-green-600'} text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm flex-shrink-0`}>
                                                                                {numeroType}
                                                                            </div>
                                                                            {traitement.type === 'desherbage' && (
                                                                                <span className="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-semibold">
                                                                                    D√âSHERBAGE
                                                                                </span>
                                                                            )}
                                                                            <Calendar className="text-gray-600" />
                                                                            <input
                                                                                type="date"
                                                                                value={traitement.date}
                                                                                onChange={(e) => modifierTraitement(parcelle.id, traitement.id, 'date', e.target.value)}
                                                                                className="px-3 py-2 border border-gray-300 rounded-lg font-semibold"/>
                                                                            
                                                                            {iftTotal > 0 && (
                                                                                <div className="ift-badge">
                                                                                    IFT: {iftTotal.toFixed(2)}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                        <div className="flex flex-col sm:flex-row gap-2">
                                                                            <button
                                                                                onClick={() => ouvrirModaleCopie(parcelle.id, traitement.id)}
                                                                                className="text-blue-600 hover:text-blue-800 p-2 sm:px-3 sm:py-2 border border-blue-300 rounded hover:bg-blue-50 flex items-center justify-center gap-1"
                                                                                title="Copier vers d'autres parcelles">
                                                                                <Copy size={18} />
                                                                                <span className="sm:hidden">Copier</span>
                                                                            </button>
                                                                            <button
                                                                                onClick={() => supprimerTraitement(parcelle.id, traitement.id)}
                                                                                className="text-red-600 hover:text-red-800 p-2 sm:px-3 sm:py-2 border border-red-300 rounded hover:bg-red-50 flex items-center justify-center gap-1"
                                                                                title="Supprimer">
                                                                                <Trash2 size={18} />
                                                                                <span className="sm:hidden">Supprimer</span>
                                                                            </button>
                                                                        </div>
                                                                    </div>

                                                                    {/* Op√©rateur et machine */}
                                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                                                        <div>
                                                                            <label className="block text-xs font-semibold text-gray-700 mb-1">Op√©rateur</label>
                                                                            <select
                                                                                value={traitement.operateur1}
                                                                                onChange={(e) => modifierTraitement(parcelle.id, traitement.id, 'operateur1', e.target.value)}
                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                                                <option value="">S√©lectionner</option>
                                                                                {operateurs.filter(op => op.trim() !== '').map((op, idx) => (
                                                                                    <option key={idx} value={op}>{op}</option>
                                                                                ))}
                                                                            </select>
                                                                        </div>
                                                                        <div>
                                                                            <label className="block text-xs font-semibold text-gray-700 mb-1">Machine</label>
                                                                            <select
                                                                                value={traitement.machine}
                                                                                onChange={(e) => {
                                                                                    const nomMachine = e.target.value;
                                                                                    const selectedMachine = machines.find(m => m.nom === nomMachine);
                                                                                    
                                                                                    setParcelles(parcelles.map(p => {
                                                                                        if (p.id === parcelle.id) {
                                                                                            return {
                                                                                                ...p,
                                                                                                traitements: p.traitements.map(t => {
                                                                                                    if (t.id === traitement.id) {
                                                                                                        return {
                                                                                                            ...t,
                                                                                                            machine: nomMachine,
                                                                                                            vitesse: selectedMachine?.vitesse || t.vitesse
                                                                                                        };
                                                                                                    }
                                                                                                    return t;
                                                                                                })
                                                                                            };
                                                                                        }
                                                                                        return p;
                                                                                    }));
                                                                                }}
                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                                                <option value="">S√©lectionner</option>
                                                                                {machines.filter(m => m.nom && m.nom.trim() !== '').map((m, idx) => (
                                                                                    <option key={idx} value={m.nom}>
                                                                                        {m.nom} {m.vitesse ? `(${m.vitesse}km/h)` : ''}
                                                                                    </option>
                                                                                ))}
                                                                            </select>
                                                                        </div>
                                                                    </div>

                                                                    {/* D√©bit */}
                                                                    <div>
                                                                        <label className="block text-xs font-semibold text-gray-700 mb-1">D√©bit (L/ha)</label>
                                                                        <input
                                                                            type="text"
                                                                            value={traitement.debit || ''}
                                                                            onChange={(e) => modifierTraitement(parcelle.id, traitement.id, 'debit', e.target.value)}
                                                                            placeholder="D√©bit (L/ha)"
                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"/>
                                                                    </div>

                                                                    {/* Produits */}
                                                                    <div className="bg-white p-3 rounded-lg border border-gray-200">
                                                                        <div className="flex items-center justify-between mb-2">
                                                                            <label className="text-sm font-semibold text-gray-700">
                                                                                Produits ({traitement.produits.length})
                                                                            </label>
                                                                            <button
                                                                                onClick={() => ajouterProduit(parcelle.id, traitement.id)}
                                                                                className="text-sm text-green-600 hover:text-green-800 font-semibold">
                                                                                + Ajouter produit
                                                                            </button>
                                                                        </div>
                                                                        <div className="space-y-2">
                                                                            {traitement.produits.map((produit, pIdx) => {
                                                                                const produitInfo = produitsDisponibles.find(p => p.nom === produit.produit);
                                                                                const ift = calculerIFT(produit.produit, produit.doseHa);
                                                                                
                                                                                return (
                                                                                    <div key={pIdx} className="grid grid-cols-12 gap-2 items-center">
                                                                                        <div className="col-span-4 relative autocomplete-container">
                                                                                            <input
                                                                                                type="text"
                                                                                                value={searchProduit[`${parcelle.id}-${traitement.id}-${pIdx}`] !== undefined 
                                                                                                    ? searchProduit[`${parcelle.id}-${traitement.id}-${pIdx}`] 
                                                                                                    : produit.produit}
                                                                                                onChange={(e) => {
                                                                                                    const key = `${parcelle.id}-${traitement.id}-${pIdx}`;
                                                                                                    setSearchProduit({...searchProduit, [key]: e.target.value});
                                                                                                    setShowSuggestions({...showSuggestions, [key]: true});
                                                                                                }}
                                                                                                onFocus={() => {
                                                                                                    const key = `${parcelle.id}-${traitement.id}-${pIdx}`;
                                                                                                    setShowSuggestions({...showSuggestions, [key]: true});
                                                                                                }}
                                                                                                onBlur={() => {
                                                                                                    const key = `${parcelle.id}-${traitement.id}-${pIdx}`;
                                                                                                    // Sauvegarder la valeur tap√©e si elle a chang√©
                                                                                                    setTimeout(() => {
                                                                                                        const valeur = searchProduit[key];
                                                                                                        if (valeur !== undefined && valeur !== produit.produit) {
                                                                                                            modifierProduit(parcelle.id, traitement.id, pIdx, 'produit', valeur);
                                                                                                        }
                                                                                                        setShowSuggestions({...showSuggestions, [key]: false});
                                                                                                    }, 200);
                                                                                                }}
                                                                                                placeholder="Rechercher un produit..."
                                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                                                                            />
                                                                                            {showSuggestions[`${parcelle.id}-${traitement.id}-${pIdx}`] && (
                                                                                                <div className="absolute z-10 w-full bg-white border border-gray-300 rounded-b shadow-lg max-h-48 overflow-y-auto">
                                                                                                    {produitsDisponibles
                                                                                                        .filter(p => {
                                                                                                            // Les adjuvants sont toujours disponibles
                                                                                                            if (p.categorie === 'Adjuvant') return true;
                                                                                                            
                                                                                                            // Filtrer selon type traitement/d√©sherbage
                                                                                                            if (traitement.type === 'desherbage') {
                                                                                                                if (p.categorie !== 'Herbicide') return false;
                                                                                                            } else {
                                                                                                                if (p.categorie === 'Herbicide') return false;
                                                                                                            }
                                                                                                            // Filtrer selon recherche
                                                                                                            const searchValue = searchProduit[`${parcelle.id}-${traitement.id}-${pIdx}`] || '';
                                                                                                            return p.nom.toLowerCase().includes(searchValue.toLowerCase());
                                                                                                        })
                                                                                                        .map((p, idx) => (
                                                                                                            <div
                                                                                                                key={idx}
                                                                                                                onClick={() => {
                                                                                                                    const key = `${parcelle.id}-${traitement.id}-${pIdx}`;
                                                                                                                    console.log('üñ±Ô∏è Clic autocompl√©tion:', {
                                                                                                                        produit: p.nom,
                                                                                                                        parcelleId: parcelle.id,
                                                                                                                        traitementId: traitement.id,
                                                                                                                        produitIdx: pIdx
                                                                                                                    });
                                                                                                                    
                                                                                                                    modifierProduit(parcelle.id, traitement.id, pIdx, 'produit', p.nom);
                                                                                                                    
                                                                                                                    // ‚≠ê Utiliser setTimeout pour que React mette √† jour l'√©tat avant de lire lotsParProduit
                                                                                                                    setTimeout(() => {
                                                                                                                        setLotsParProduit(currentLots => {
                                                                                                                            // Pr√©-remplir le num√©ro de lot s'il est m√©moris√©
                                                                                                                            if (currentLots[p.nom]) {
                                                                                                                                console.log('üè∑Ô∏è Pr√©-remplissage lot pour', p.nom, ':', currentLots[p.nom]);
                                                                                                                                modifierProduit(parcelle.id, traitement.id, pIdx, 'numeroLot', currentLots[p.nom]);
                                                                                                                            } else {
                                                                                                                                console.log('‚ö†Ô∏è Pas de lot m√©moris√© pour', p.nom);
                                                                                                                                console.log('üìã Lots disponibles:', Object.keys(currentLots));
                                                                                                                            }
                                                                                                                            // Retourner l'√©tat inchang√©
                                                                                                                            return currentLots;
                                                                                                                        });
                                                                                                                    }, 0);
                                                                                                                    
                                                                                                                    setSearchProduit({...searchProduit, [key]: p.nom});
                                                                                                                    setShowSuggestions({...showSuggestions, [key]: false});
                                                                                                                    
                                                                                                                    console.log('‚úÖ Autocompl√©tion termin√©e');
                                                                                                                }}
                                                                                                                className="px-3 py-2 hover:bg-green-100 cursor-pointer text-sm border-b border-gray-100"
                                                                                                            >
                                                                                                                <div className="font-medium">{p.nom}</div>
                                                                                                                <div className="text-xs text-gray-500">
                                                                                                                    {p.categorie} - {p.doseRef} {p.unite}
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        ))
                                                                                                    }
                                                                                                    {produitsDisponibles.filter(p => {
                                                                                                        // Les adjuvants sont toujours disponibles
                                                                                                        if (p.categorie === 'Adjuvant') return true;
                                                                                                        
                                                                                                        if (traitement.type === 'desherbage') {
                                                                                                            if (p.categorie !== 'Herbicide') return false;
                                                                                                        } else {
                                                                                                            if (p.categorie === 'Herbicide') return false;
                                                                                                        }
                                                                                                        const searchValue = searchProduit[`${parcelle.id}-${traitement.id}-${pIdx}`] || '';
                                                                                                        return p.nom.toLowerCase().includes(searchValue.toLowerCase());
                                                                                                    }).length === 0 && (
                                                                                                        <div className="px-3 py-2 text-sm text-gray-500 italic">
                                                                                                            Aucun produit trouv√©
                                                                                                        </div>
                                                                                                    )}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>
                                                                                        <div className="col-span-3">
                                                                                            <input
                                                                                                type="text"
                                                                                                value={produit.numeroLot}
                                                                                                onChange={(e) => modifierProduit(parcelle.id, traitement.id, pIdx, 'numeroLot', e.target.value)}
                                                                                                placeholder="N¬∞ lot"
                                                                                                maxLength="15"
                                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm"/>
                                                                                        </div>
                                                                                        <div className="col-span-2">
                                                                                            <input
                                                                                                type="text"
                                                                                                value={produit.doseHa}
                                                                                                onChange={(e) => modifierProduit(parcelle.id, traitement.id, pIdx, 'doseHa', e.target.value)}
                                                                                                placeholder={produitInfo ? produitInfo.unite : "Dose/ha"}
                                                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm"/>
                                                                                        </div>
                                                                                        <div className="col-span-2 text-center">
                                                                                            {produit.produit && produit.doseHa ? (
                                                                                                produitInfo && produitInfo.categorie === 'Adjuvant' ? (
                                                                                                    <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded" title="Les adjuvants ne comptent pas dans l'IFT">
                                                                                                        Adjuvant
                                                                                                    </span>
                                                                                                ) : ift > 0 ? (
                                                                                                    <span className="text-xs font-bold text-green-700 bg-green-50 px-2 py-1 rounded">
                                                                                                        IFT: {ift.toFixed(2)}
                                                                                                    </span>
                                                                                                ) : (
                                                                                                    <span className="text-xs font-bold text-gray-500 bg-gray-50 px-2 py-1 rounded" title="Produit sans dose de r√©f√©rence ou dose invalide">
                                                                                                        IFT: N/A
                                                                                                    </span>
                                                                                                )
                                                                                            ) : null}
                                                                                        </div>
                                                                                        <div className="col-span-1 flex justify-center">
                                                                                            {traitement.produits.length > 1 && (
                                                                                                <button
                                                                                                    onClick={() => supprimerProduit(parcelle.id, traitement.id, pIdx)}
                                                                                                    className="text-red-600 hover:text-red-800">
                                                                                                    <Trash2 size={16}/>
                                                                                                </button>
                                                                                            )}
                                                                                        </div>
                                                                                    </div>
                                                                                );
                                                                            })}
                                                                        </div>
                                                                    </div>

                                                                    {/* Commentaire */}
                                                                    <div className="mt-3">
                                                                        <label className="block text-xs font-semibold text-gray-700 mb-1">Commentaire (optionnel)</label>
                                                                        <textarea
                                                                            value={traitement.commentaire || ''}
                                                                            onChange={(e) => modifierTraitement(parcelle.id, traitement.id, 'commentaire', e.target.value)}
                                                                            placeholder="Notes, observations..."
                                                                            rows="2"
                                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none"
                                                                        />
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                ) : (
                                                    <p className="text-gray-500 text-center py-8">Aucun traitement enregistr√©</p>
                                                )}
                                            </div>
                                        ))}
                                        
                                        {/* Bouton pour replier l'√Ælot depuis le bas */}
                                        <div className="mt-6 pt-4 border-t-2 border-gray-200">
                                            <button
                                                onClick={() => toggleIlot(ilot.nom)}
                                                className="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all">
                                                <ChevronUp /> Replier {ilot.nom}
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Modal de copie */}
            {showCopyModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-2xl">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800">Copier vers d'autres parcelles</h3>
                        {ilots.map(ilot => {
                            const parcellesIlot = parcelles.filter(p => p.ilot === ilot.nom && p.id !== traitementACopier?.parcelleId);
                            const nbSel = parcellesIlot.filter(p => parcellesSelectionnees.includes(p.id)).length;
                            
                            return (
                                <div key={ilot.nom} className="mb-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <input
                                            type="checkbox"
                                            checked={parcellesIlot.length > 0 && parcellesIlot.every(p => parcellesSelectionnees.includes(p.id))}
                                            onChange={() => selectionnerToutIlot(ilot.nom)}
                                            className="w-4 h-4"/>
                                        <label className="font-semibold text-gray-700">
                                            {ilot.nom} ({nbSel}/{parcellesIlot.length})
                                        </label>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 ml-6">
                                        {parcellesIlot.map(p => (
                                            <label key={p.id} className="flex items-center gap-2 text-sm">
                                                <input
                                                    type="checkbox"
                                                    checked={parcellesSelectionnees.includes(p.id)}
                                                    onChange={() => toggleParcelleSelection(p.id)}
                                                    className="w-4 h-4"/>
                                                {p.nom}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={copierTraitement}
                                disabled={parcellesSelectionnees.length === 0}
                                className="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Copier vers {parcellesSelectionnees.length} parcelle(s)
                            </button>
                            <button
                                onClick={() => { 
                                    setShowCopyModal(false); 
                                    setTraitementACopier(null); 
                                    setParcellesSelectionnees([]); 
                                }}
                                className="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                Annuler
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Modal Traitement/D√©sherbage Global */}
            {(showTraitementGlobal || showDesherbageGlobal) && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="bg-white rounded-2xl p-6 max-w-4xl w-full my-8 shadow-2xl">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800">
                            {showTraitementGlobal ? 'üåø Traitement global' : 'üöú D√©sherbage global'}
                        </h3>
                        
                        {/* Formulaire du traitement */}
                        <div className="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 className="font-bold text-gray-700 mb-3">Informations du traitement</h4>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                                    <input
                                        type="date"
                                        value={traitementGlobal.date}
                                        onChange={(e) => setTraitementGlobal({...traitementGlobal, date: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Op√©rateur</label>
                                    <select
                                        value={traitementGlobal.operateur1}
                                        onChange={(e) => setTraitementGlobal({...traitementGlobal, operateur1: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="">S√©lectionner...</option>
                                        {operateurs.filter(op => op && op.trim()).map((op, idx) => (
                                            <option key={idx} value={op}>{op}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Machine</label>
                                    <select
                                        value={traitementGlobal.machine}
                                        onChange={(e) => setTraitementGlobal({...traitementGlobal, machine: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="">S√©lectionner...</option>
                                        {machines.map((m, idx) => (
                                            m.nom && <option key={idx} value={m.nom}>{m.nom}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">D√©bit (L/ha)</label>
                                    <input
                                        type="text"
                                        value={traitementGlobal.debit}
                                        onChange={(e) => setTraitementGlobal({...traitementGlobal, debit: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                        placeholder="Ex: 400"/>
                                </div>
                            </div>
                            
                            {/* Produits */}
                            <div className="mb-4">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Produits *</label>
                                {traitementGlobal.produits.map((produit, pIdx) => (
                                    <div key={pIdx} className="grid grid-cols-12 gap-2 mb-2">
                                        <select
                                            value={produit.produit}
                                            onChange={(e) => {
                                                const newProduits = [...traitementGlobal.produits];
                                                newProduits[pIdx].produit = e.target.value;
                                                setTraitementGlobal({...traitementGlobal, produits: newProduits});
                                            }}
                                            className="col-span-5 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            <option value="">Produit...</option>
                                            {produitsDisponibles
                                                .filter(p => {
                                                    if (p.categorie === 'Adjuvant') return true;
                                                    if (showDesherbageGlobal) return p.categorie === 'Herbicide';
                                                    return p.categorie !== 'Herbicide';
                                                })
                                                .map((p, idx) => (
                                                    <option key={idx} value={p.nom}>{p.nom}</option>
                                                ))
                                            }
                                        </select>
                                        <input
                                            type="text"
                                            value={produit.numeroLot}
                                            onChange={(e) => {
                                                const newProduits = [...traitementGlobal.produits];
                                                newProduits[pIdx].numeroLot = e.target.value;
                                                setTraitementGlobal({...traitementGlobal, produits: newProduits});
                                            }}
                                            className="col-span-3 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                            placeholder="N¬∞ lot"/>
                                        <input
                                            type="text"
                                            value={produit.doseHa}
                                            onChange={(e) => {
                                                const newProduits = [...traitementGlobal.produits];
                                                newProduits[pIdx].doseHa = e.target.value;
                                                setTraitementGlobal({...traitementGlobal, produits: newProduits});
                                            }}
                                            className="col-span-3 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                            placeholder="Dose/ha"/>
                                        <button
                                            onClick={() => {
                                                if (traitementGlobal.produits.length > 1) {
                                                    const newProduits = traitementGlobal.produits.filter((_, i) => i !== pIdx);
                                                    setTraitementGlobal({...traitementGlobal, produits: newProduits});
                                                }
                                            }}
                                            className="col-span-1 text-red-600 hover:text-red-800">
                                            <Trash2 size={18} />
                                        </button>
                                    </div>
                                ))}
                                <button
                                    onClick={() => {
                                        setTraitementGlobal({
                                            ...traitementGlobal,
                                            produits: [...traitementGlobal.produits, { produit: '', numeroLot: '', doseHa: '' }]
                                        });
                                    }}
                                    className="text-sm text-green-600 hover:text-green-700 font-semibold flex items-center gap-1">
                                    <Plus size={16} /> Ajouter un produit
                                </button>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Commentaire</label>
                                <textarea
                                    value={traitementGlobal.commentaire}
                                    onChange={(e) => setTraitementGlobal({...traitementGlobal, commentaire: e.target.value})}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    rows="2"
                                    placeholder="Commentaire facultatif..."/>
                            </div>
                        </div>
                        
                        {/* S√©lection des parcelles */}
                        <div className="bg-blue-50 p-4 rounded-lg mb-6 max-h-[40vh] overflow-y-auto">
                            <h4 className="font-bold text-gray-700 mb-3">S√©lectionner les parcelles *</h4>
                            {ilots.map(ilot => {
                                const parcellesIlot = parcelles.filter(p => p.ilot === ilot.nom);
                                const nbSel = parcellesIlot.filter(p => parcellesSelectionneesglobal.includes(p.id)).length;
                                
                                return (
                                    <div key={ilot.nom} className="mb-3">
                                        <div className="flex items-center gap-2 mb-2">
                                            <input
                                                type="checkbox"
                                                checked={parcellesIlot.length > 0 && parcellesIlot.every(p => parcellesSelectionneesglobal.includes(p.id))}
                                                onChange={() => {
                                                    const parcelleIds = parcellesIlot.map(p => p.id);
                                                    if (parcellesIlot.every(p => parcellesSelectionneesglobal.includes(p.id))) {
                                                        setParcellesSelectionneesGlobal(parcellesSelectionneesglobal.filter(id => !parcelleIds.includes(id)));
                                                    } else {
                                                        setParcellesSelectionneesGlobal([...new Set([...parcellesSelectionneesglobal, ...parcelleIds])]);
                                                    }
                                                }}
                                                className="w-4 h-4"/>
                                            <label className="font-semibold text-gray-700">
                                                {ilot.nom} ({nbSel}/{parcellesIlot.length})
                                            </label>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2 ml-6">
                                            {parcellesIlot.map(p => (
                                                <label key={p.id} className="flex items-center gap-2 text-sm">
                                                    <input
                                                        type="checkbox"
                                                        checked={parcellesSelectionneesglobal.includes(p.id)}
                                                        onChange={() => {
                                                            if (parcellesSelectionneesglobal.includes(p.id)) {
                                                                setParcellesSelectionneesGlobal(parcellesSelectionneesglobal.filter(id => id !== p.id));
                                                            } else {
                                                                setParcellesSelectionneesGlobal([...parcellesSelectionneesglobal, p.id]);
                                                            }
                                                        }}
                                                        className="w-4 h-4"/>
                                                    {p.nom}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Boutons d'action */}
                        <div className="flex gap-3">
                            <button
                                onClick={appliquerTraitementGlobal}
                                disabled={!traitementGlobal.date || parcellesSelectionneesglobal.length === 0}
                                className="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Appliquer √† {parcellesSelectionneesglobal.length} parcelle(s)
                            </button>
                            <button
                                onClick={() => { 
                                    setShowTraitementGlobal(false); 
                                    setShowDesherbageGlobal(false); 
                                }}
                                className="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                Annuler
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Modal de gestion des parcelles */}
            {showGestionParcelles && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto shadow-2xl">
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="text-2xl font-bold text-gray-800">Gestion des parcelles</h3>
                            <button
                                onClick={() => setShowGestionParcelles(false)}
                                className="text-gray-500 hover:text-gray-700 text-2xl font-bold">
                                √ó
                            </button>
                        </div>
                        
                        <div className="space-y-6">
                            {ilots.map(ilot => {
                                const parcellesIlot = parcelles.filter(p => p.ilot === ilot.nom);
                                
                                return (
                                    <div key={ilot.nom} className="border-2 border-gray-200 rounded-xl p-4">
                                        <div className="flex items-center justify-between mb-4">
                                            <h4 className="text-xl font-bold text-gray-800">{ilot.nom}</h4>
                                            <button
                                                onClick={() => ajouterParcelle(ilot.nom)}
                                                className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm font-semibold flex items-center gap-1">
                                                <Plus size={16} /> Ajouter
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-2">
                                            {parcellesIlot.map(parcelle => (
                                                <div key={parcelle.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                                    <div className="flex-1">
                                                        <span className="font-semibold text-gray-700">{parcelle.nom}</span>
                                                        {parcelle.surface && (
                                                            <span className="ml-3 text-sm text-gray-500">({parcelle.surface} ha)</span>
                                                        )}
                                                        {parcelle.traitements.length > 0 && (
                                                            <span className="ml-3 text-sm text-blue-600">
                                                                {parcelle.traitements.length} traitement(s)
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => modifierNomParcelle(parcelle.id)}
                                                            className="text-blue-600 hover:text-blue-800 p-2"
                                                            title="Modifier le nom">
                                                            <Edit size={18} />
                                                        </button>
                                                        <button
                                                            onClick={() => supprimerParcelle(parcelle.id)}
                                                            className="text-red-600 hover:text-red-800 p-2"
                                                            title="Supprimer">
                                                            <Trash2 size={18} />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                            
                                            {parcellesIlot.length === 0 && (
                                                <p className="text-gray-500 text-center py-4 italic">Aucune parcelle dans cet √Ælot</p>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div className="mt-6 flex justify-end">
                            <button
                                onClick={() => setShowGestionParcelles(false)}
                                className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Modal Gestion des produits */}
            {showGestionProduits && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl p-6 max-w-5xl w-full max-h-[80vh] overflow-y-auto shadow-2xl">
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="text-2xl font-bold text-gray-800">Gestion des produits phytosanitaires</h3>
                            <button
                                onClick={() => setShowGestionProduits(false)}
                                className="text-gray-500 hover:text-gray-700 text-2xl font-bold">
                                √ó
                            </button>
                        </div>
                        
                        <div className="mb-6 flex gap-3">
                            <button
                                onClick={ajouterProduitListe}
                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                                <Plus size={18} /> Ajouter un produit
                            </button>
                        </div>
                        
                        <div className="mb-4 text-sm text-gray-600">
                            Total : {produitsDisponibles.length} produit(s)
                        </div>
                        
                        {/* Liste des produits par cat√©gorie */}
                        {['Fongicide', 'Insecticide', 'Herbicide', 'Adjuvant', 'Autre'].map(categorie => {
                            const produitsCategorie = produitsDisponibles.filter(p => p.categorie === categorie);
                            if (produitsCategorie.length === 0) return null;
                            
                            return (
                                <div key={categorie} className="mb-6">
                                    <h4 className="text-lg font-bold text-gray-700 mb-3 pb-2 border-b-2 border-gray-200">
                                        {categorie}s ({produitsCategorie.length})
                                    </h4>
                                    <div className="grid grid-cols-1 gap-2">
                                        {produitsCategorie.map((produit, idx) => {
                                            const globalIndex = produitsDisponibles.indexOf(produit);
                                            return (
                                                <div key={globalIndex} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg hover:bg-gray-100 transition">
                                                    <div className="flex-1 grid grid-cols-3 gap-4">
                                                        <div>
                                                            <span className="font-semibold text-gray-800">{produit.nom}</span>
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Dose ref: <span className="font-semibold">{produit.doseRef} {produit.unite}</span>
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            <span className={`px-2 py-1 rounded ${
                                                                categorie === 'Fongicide' ? 'bg-blue-100 text-blue-700' :
                                                                categorie === 'Insecticide' ? 'bg-yellow-100 text-yellow-700' :
                                                                categorie === 'Herbicide' ? 'bg-green-100 text-green-700' :
                                                                categorie === 'Adjuvant' ? 'bg-purple-100 text-purple-700' :
                                                                'bg-gray-200 text-gray-700'
                                                            }`}>
                                                                {produit.categorie}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 ml-4">
                                                        <button
                                                            onClick={() => modifierProduitListe(globalIndex)}
                                                            className="text-blue-600 hover:text-blue-800 p-2"
                                                            title="Modifier">
                                                            <Edit size={18} />
                                                        </button>
                                                        <button
                                                            onClick={() => supprimerProduitListe(globalIndex)}
                                                            className="text-red-600 hover:text-red-800 p-2"
                                                            title="Supprimer">
                                                            <Trash2 size={18} />
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                        
                        <div className="mt-6 flex justify-end">
                            <button
                                onClick={() => setShowGestionProduits(false)}
                                className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

ReactDOM.render(<PhytoTracker/>, document.getElementById('root'));
    </script>
</body>
</html>
